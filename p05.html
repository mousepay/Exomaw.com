<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pista 5 — Agujas + Damas</title>
<style>
  :root{ --text:#0c2621; --card:rgba(255,255,255,.86); --ok:#0b8d42; --bad:#c4382e; --warn:#f0b429; --board-dark:#0c3a28; --board-light:#e2f6ea; }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  body{color:var(--text);background:#e7efe9 center/cover fixed no-repeat} /* JS pondrá el fondo de butacas */
  .wrap{max-width:1200px;margin:18px auto 96px;padding:0 16px}
  .topbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .link-back{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:#eef6f4;color:#184a42;border:1px solid rgba(0,0,0,.08)}
  h1{margin:0;font-size:clamp(26px,4vw,46px);color:#fff;text-shadow:0 2px 18px rgba(0,0,0,.45)}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:#0ea5a3;color:#052a27;box-shadow:0 6px 24px rgba(14,165,163,.25)}
  .card{background:var(--card);border:1px solid rgba(0,0,0,.08);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
  .areas{display:grid;gap:18px;grid-template-columns:1fr 1fr}
  @media(max-width:980px){.areas{grid-template-columns:1fr}}
  .panel-title{font-size:22px;margin:2px 0 10px}
  .slots,.library{background:#fff;border:1px dashed rgba(0,0,0,.20);border-radius:16px;padding:16px;min-height:260px;display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:14px}
  .slot,.needle{position:relative;display:flex;align-items:center;justify-content:center;border-radius:14px;overflow:hidden;background:#f5faf8;border:1px solid rgba(0,0,0,.12);min-height:140px;box-shadow:inset 0 12px 24px rgba(0,0,0,.05)}
  .slot .ghost{position:absolute;inset:10px;background-position:center;background-repeat:no-repeat;background-size:contain;opacity:.28;filter:grayscale(1) contrast(.9);pointer-events:none}
  .slot.is-target{outline:2px solid var(--warn);box-shadow:0 0 0 6px rgba(240,180,41,.15) inset}
  .slot.correct{outline:2px solid var(--ok);box-shadow:0 0 0 6px rgba(11,141,66,.18) inset}
  .slot.fail{outline:2px solid var(--bad);box-shadow:0 0 0 6px rgba(196,56,46,.18) inset}
  .needle{cursor:grab;transition:transform .08s ease}
  .needle:active{transform:scale(.98)}
  .needle img,.slot img{max-width:88px;max-height:110px;object-fit:contain;filter:drop-shadow(0 4px 10px rgba(0,0,0,.35))}
  .hint{font-size:14px;color:#0a4b41}
  .final-msg{display:none;margin-top:12px;padding:12px;background:#f2fbf8;border:1px solid rgba(0,0,0,.1);border-radius:12px;color:#0a3a32}
  .flash{position:fixed;inset:0;pointer-events:none;background:radial-gradient(circle at 50% 45%,rgba(255,255,255,.9),rgba(255,255,255,0) 55%);opacity:0;transition:opacity .35s}
  .flash.on{opacity:1;animation:fadeFlash .9s ease forwards}
  @keyframes fadeFlash{0%{opacity:1}60%{opacity:.45}100%{opacity:0}}
  /* Damas */
  .overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:50}
  .overlay.show{display:grid}
  .modal{width:min(980px,94vw);background:#fff;color:#0b2a24;border-radius:16px;padding:16px 18px 18px;box-shadow:0 30px 80px rgba(0,0,0,.35);border:1px solid rgba(0,0,0,.08)}
  .board-wrap{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media(max-width:980px){.board-wrap{grid-template-columns:1fr}}
  .board{width:100%;aspect-ratio:1/1;max-width:620px;margin:auto;border-radius:16px;overflow:hidden;border:1px solid rgba(0,0,0,.1);box-shadow:0 12px 28px rgba(0,0,0,.25)}
  .grid{display:grid;grid-template-columns:repeat(8,1fr);width:100%;height:100%}
  .sq{display:flex;align-items:center;justify-content:center}
  .sq.dark{background:var(--board-dark)} .sq.light{background:var(--board-light)}
  .piece{width:min(66px,9.4vmin);height:min(66px,9.4vmin);border-radius:50%;display:grid;place-items:center;border:3px solid rgba(0,0,0,.35);box-shadow:0 8px 20px rgba(0,0,0,.28);background-size:72% auto;background-position:center;background-repeat:no-repeat}
  .piece.player{background:#1e7f58} .piece.ai{background:#b84239}
  .sq.target{outline:3px solid var(--warn);box-shadow:inset 0 0 0 6px rgba(240,180,41,.25)}
  .status{font-size:15px;color:#0e3b33;background:#f3fbf8;border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:12px;margin-top:10px}
  .banner{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:rgba(255,255,255,.95);border:1px solid rgba(0,0,0,.12);color:#083831;padding:12px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);display:none;z-index:60}
  .banner.show{display:block}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <button class="link-back" onclick="history.back()">← Volver a las pistas</button>
      <h1>PISTA 5 — El enigma de las agujas</h1>
      <button id="openCheckersTop" class="btn">Ir al tablero de damas</button>
    </div>

    <div class="card">
      <p>Arrastra cada <strong>aguja</strong> desde la biblioteca hasta su <strong>molde</strong> (silueta real). Tienes <strong>3 fallos</strong> en total. Al completar las 12 y colocar la <em>aguja de luz</em>, podrás pasar al duelo de damas.</p>

      <div class="areas">
        <section>
          <div class="panel-title">Ranuras (sombras)</div>
          <div id="slots" class="slots"></div>
          <p class="hint">Las sombras usan la misma imagen a baja opacidad para encajar como puzzle.</p>
        </section>

        <section>
          <div class="panel-title">Biblioteca de agujas</div>
          <div id="library" class="library"></div>
          <p class="hint">Completa todas. La “aguja de luz” revelará la pista y abrirá el tablero.</p>
        </section>
      </div>

      <div id="finalClue" class="final-msg"></div>
    </div>
  </div>

  <!-- Tablero de damas -->
  <div id="checkers" class="overlay" aria-modal="true" role="dialog" aria-label="Tablero de damas">
    <div class="modal">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
        <h2 style="margin:0;color:#083831">Duelo de damas</h2>
        <button id="closeCheckers" class="btn" style="background:#e8f4f2;color:#08534a">Cerrar</button>
      </div>
      <div class="board-wrap" style="margin-top:10px">
        <div>
          <div class="board"><div id="grid" class="grid"></div></div>
          <div id="status" class="status">Mueve una ficha <strong>verde</strong> (todas con su silueta). Rondas 1 y 2: gana la máquina; ronda 3: te deja ganar y aparece el mensaje de Nora.</div>
        </div>
        <div class="card" style="margin:0">
          <h3 style="margin:6px 0 8px;color:#0c463d">Siluetas usadas</h3>
          <p style="margin:0">Amelia, Arturo, Azquiel, Daniel, Lise, Nora, Ocaña, Tomás.</p>
          <button id="resetDemo" class="btn" style="margin-top:8px">Reiniciar demo</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="banner"></div>
  <div class="flash" id="flash"></div>

<script>
/* ========= Helpers ========= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function say(msg, ms=1800){ const b=$("#toast"); b.textContent=msg; b.classList.add("show"); setTimeout(()=>b.classList.remove("show"), ms); }

/* ========= Resolver rutas automáticamente (pista5/) ========= */
async function pickBase(candidates){
  for(const base of candidates){
    const ok = await new Promise(res=>{ const i=new Image(); i.onload=()=>res(true); i.onerror=()=>res(false); i.src=base+"aguja01.png"; });
    if(ok) return base;
  }
  return candidates[0]; // fallback
}
(async()=>{
  // intenta varias bases para Vercel
  const BASES = ["pista5/","/pista5/","./pista5/","../pista5/"];
  const BASE = await pickBase(BASES);

  // pone el fondo de butacas (primer fondo que exista)
  const fondos = [BASE+"fondo.png","/fondo.png","pista3/fondo.png","/pista3/fondo.png"];
  for(const src of fondos){
    const ok = await new Promise(r=>{ const i=new Image(); i.onload=()=>r(true); i.onerror=()=>r(false); i.src=src; });
    if(ok){ document.body.style.backgroundImage = `url('${src}')`; break; }
  }

  /* ====== PUZZLE de 12 agujas ====== */
  (function(){
    const ids = ["aguja01","aguja02","aguja03","aguja04","aguja05","aguja06","aguja07","aguja08","aguja09","aguja010","aguja011","aguja_luz"];
    const NEEDLES = ids.map(id=>({ id, img: BASE+id+".png", name:id.toUpperCase() }));
    const LIGHT_ID = "aguja_luz";

    const HIT  = ["¡Bien! Esa encaja como un guante.","Perfecto. Tu pulso es exacto.","Otro paso hacia la verdad."];
    const MISS = ["No pasa nada. Observa la silueta y vuelve a intentar.","Casi… mira la punta y el grosor.","Respira. La forma te guía."];
    const RESET= ["Tres fallos: el mecanismo se desmonta. Empieza de nuevo.","Reinicio del reloj. La paciencia también es una pista.","Se reinicia el rompecabezas, pero tu mente sigue afilada."];

    const slotsEl=$("#slots"), libEl=$("#library"), finalBox=$("#finalClue"), flash=$("#flash");
    let fails=0, solved=0, lightPlaced=false;

    function build(){
      slotsEl.innerHTML=""; libEl.innerHTML=""; finalBox.style.display="none"; finalBox.innerHTML=""; fails=0; solved=0; lightPlaced=false;

      NEEDLES.forEach(n=>{
        const s=document.createElement("div"); s.className="slot"; s.dataset.accept=n.id;
        const ghost=document.createElement("div"); ghost.className="ghost"; ghost.style.backgroundImage=`url("${n.img}")`; s.appendChild(ghost);
        s.addEventListener("dragover",e=>{e.preventDefault(); s.classList.add("is-target");});
        s.addEventListener("dragleave",()=>s.classList.remove("is-target"));
        s.addEventListener("drop",e=>{e.preventDefault(); s.classList.remove("is-target"); handleDrop(s,e.dataTransfer.getData("text/needle"));});
        slotsEl.appendChild(s);
      });

      NEEDLES.forEach(n=>{
        const d=document.createElement("div"); d.className="needle"; d.draggable=true; d.dataset.id=n.id; d.title=n.name;
        d.addEventListener("dragstart",e=> e.dataTransfer.setData("text/needle", n.id));
        const img=document.createElement("img"); img.src=n.img; img.alt=n.name; d.appendChild(img);
        libEl.appendChild(d);
      });
    }

    function handleDrop(slot, draggedId){
      const accept = slot.dataset.accept;
      if(slot.classList.contains("correct")) { say("Esa ranura ya está completa"); return; }
      if(draggedId===accept){
        slot.classList.add("correct"); solved++;
        const n = NEEDLES.find(x=>x.id===draggedId);
        slot.innerHTML=""; const img=document.createElement("img"); img.src=n?.img||""; img.alt=n?.name||""; slot.appendChild(img);
        say(HIT[Math.floor(Math.random()*HIT.length)]);
        if(draggedId===LIGHT_ID){ lightPlaced=true; flash.classList.add("on"); setTimeout(()=>flash.classList.remove("on"),900); }
        if(solved===NEEDLES.length){
          finalBox.style.display="block";
          finalBox.innerHTML = `<strong>¡Puzzle completo!</strong><br>Las agujas han hablado: <em>siempre apuntan a nuestro centro</em>.<br><br>${lightPlaced ? "Reto desbloqueado: intenta <strong>ganar el duelo de damas</strong> para llegar a la pista final." : "Coloca también la <strong>aguja de luz</strong> para desbloquear el duelo de damas."}`;
        }
      }else{
        slot.classList.add("fail"); setTimeout(()=>slot.classList.remove("fail"),700);
        if(++fails>=3){ say(RESET[Math.floor(Math.random()*RESET.length)],2200); setTimeout(build,900); }
        else{ say(MISS[Math.floor(Math.random()*MISS.length)]); }
      }
    }

    build();
  })();

  /* ====== DAMAS — 8 verdes con silueta + 8 rojas ====== */
  (function(){
    const overlay=$("#checkers"), btnTop=$("#openCheckersTop"), closeBtn=$("#closeCheckers"), resetBtn=$("#resetDemo");
    const grid=$("#grid"), status=$("#status");

    const SPRITES = {
      "Amelia": BASE+"amelia.png","Arturo": BASE+"arturo.png","Azquiel": BASE+"azquiel.png","Daniel": BASE+"daniel1.png",
      "Lise": BASE+"lise.png","Nora": BASE+"nora.png","Ocaña": BASE+"ocana.png","Tomás": BASE+"tomas.png"
    };
    const LOSE = ["¡Ánimo! Cada jugada te enseña algo.","Vas bien, piensa dos movimientos por delante.","No te rindas, el final está cerca."];

    let round=1, selected=null, pieces=null; const SIZE=8;

    btnTop.addEventListener("click", ()=> overlay.classList.add("show"));
    closeBtn.addEventListener("click", ()=> overlay.classList.remove("show"));
    resetBtn?.addEventListener("click", ()=>{ round=1; init(true); });
    document.addEventListener("keydown", e=>{ if(e.key==="Escape") overlay.classList.remove("show"); });

    function init(resetText=false){
      grid.innerHTML=""; selected=null;
      // 8 VERDES (dos filas) y 8 ROJAS (dos filas), solo en casillas oscuras
      pieces = {
        player:new Set(["5,0","5,2","5,4","5,6","6,1","6,3","6,5","6,7"]),
        ai:    new Set(["1,0","1,2","1,4","1,6","2,1","2,3","2,5","2,7"])
      };
      if(resetText) status.innerHTML="Empieza la demo: la máquina ganará dos veces; a la tercera te deja ganar.";
      draw();
    }

    function draw(){
      grid.innerHTML="";
      for(let r=0;r<SIZE;r++){
        for(let c=0;c<SIZE;c++){
          const cell=document.createElement("div");
          cell.className="sq "+((r+c)%2?"dark":"light");
          cell.dataset.r=r; cell.dataset.c=c;
          const key=`${r},${c}`;
          if(pieces.player.has(key)){
            const p=document.createElement("div"); p.className="piece player";
            const name=nameFor(key); p.title=name; const sprite=SPRITES[name]; if(sprite) p.style.backgroundImage=`url("${sprite}")`;
            cell.appendChild(p);
          }else if(pieces.ai.has(key)){
            const p=document.createElement("div"); p.className="piece ai"; cell.appendChild(p);
          }
          cell.addEventListener("click", ()=> onClick(r,c));
          grid.appendChild(cell);
        }
      }
      markTargets();
    }

    function nameFor(key){
      // asigna las 8 siluetas por orden a las 8 verdes
      const order=["5,0","5,2","5,4","5,6","6,1","6,3","6,5","6,7"];
      const names=["Amelia","Arturo","Azquiel","Daniel","Lise","Nora","Ocaña","Tomás"];
      const i=order.indexOf(key); return names[i]||"Jugador";
    }

    const isLight=(r,c)=>(r+c)%2===0;
    const isEmpty=(r,c)=>!pieces.player.has(`${r},${c}`)&&!pieces.ai.has(`${r},${c}`);
    const isAdj=(r1,c1,r2,c2)=>Math.abs(r1-r2)===1&&Math.abs(c1-c2)===1;

    function onClick(r,c){
      const key=`${r},${c}`;
      if(pieces.player.has(key)){ selected={r,c}; draw(); return; }
      if(selected && isLight(r,c) && isEmpty(r,c) && isAdj(selected.r,selected.c,r,c)){
        pieces.player.delete(`${selected.r},${selected.c}`); pieces.player.add(`${r},${c}`); selected=null; draw();
        setTimeout(aiMove, 300);
      }
    }

    function markTargets(){
      if(!selected) return;
      $$(".sq").forEach(cell=>{
        const r=+cell.dataset.r, c=+cell.dataset.c;
        if(isLight(r,c)&&isEmpty(r,c)&&isAdj(selected.r,selected.c,r,c)) cell.classList.add("target");
        else cell.classList.remove("target");
      });
    }

    function aiMove(){
      if(round===1||round===2){
        stepAI(); draw();
        say(LOSE[Math.floor(Math.random()*LOSE.length)], 1700);
        setTimeout(()=> endAIWins(), 700);
      } else {
        stepAI(); draw();
        status.textContent="Tu turno. Puedes forzar la victoria.";
        const w=setInterval(()=>{
          for(const k of pieces.player){
            const r=+k.split(",")[0];
            if(r<=2 || pieces.ai.size<=3){ clearInterval(w); endPlayerWins(); break; }
          }
        },250);
      }
    }
    function stepAI(){
      const cand=Array.from(pieces.ai).map(k=>k.split(",").map(Number));
      for(const [r,c] of cand){
        for(const [nr,nc] of [[r+1,c-1],[r+1,c+1]]){
          if(nr<SIZE&&nc>=0&&nc<SIZE&&isLight(nr,nc)&&isEmpty(nr,nc)){
            pieces.ai.delete(`${r},${c}`); pieces.ai.add(`${nr},${nc}`); return;
          }
        }
      }
    }
    function endAIWins(){ status.innerHTML="La máquina te ha ganado esta ronda. Respira, observa y vuelve a intentarlo."; round++; setTimeout(()=>init(),700); }
    function endPlayerWins(){
      const b=document.createElement("div"); b.className="banner show";
      b.innerHTML='Nora: <em>Al final de la línea del reloj has llegado a la novela… ¿me seguirás en mi próxima aventura?</em>';
      document.body.appendChild(b); setTimeout(()=>b.remove(),5200);
      round=1; setTimeout(()=>init(),1400);
    }

    init(true);
  })();
})();
</script>
</body>
</html>








