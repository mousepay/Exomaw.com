<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PISTA 5 — Memoria de agujas</title>
<style>
  :root{ --ink:#0c2f29; --muted:#2b5f55; --ok:#118754; --bad:#c43a2e; --warn:#f0b429; --brand:#0ea5a3; --pane:rgba(255,255,255,.9); }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
  body{
    /* Puedes cambiar por tu fondo si quieres: */
    /* background:url('fondo.png') center/cover fixed no-repeat; */
    background: radial-gradient(1200px 900px at 30% 0%, #eaf7f2, #d8efe6 60%, #cde6de);
  }
  .wrap{max-width:1100px;margin:26px auto 90px;padding:0 16px}
  .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .back{border:1px solid #cfe6df;background:#f5fbf9;color:#1c534a;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  h1{margin:6px 0 12px;font-size:clamp(26px,4vw,44px);color:#fff;text-shadow:0 2px 18px rgba(0,0,0,.45)}
  .card{background:var(--pane);backdrop-filter:blur(6px);border:1px solid rgba(0,0,0,.08);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
  .hud{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 12px}
  .pill{padding:6px 10px;border-radius:999px;background:#eef7f5;border:1px solid #cfe6df;color:#17584c;font-size:14px}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .primary{background:var(--brand);color:#053f3b}
  .ghost{background:#eef7f5;color:#0c4a3f;border:1px solid #cfe6df}

  .grid{display:grid;gap:12px;grid-template-columns:repeat(6,1fr)}
  @media(max-width:960px){.grid{grid-template-columns:repeat(4,1fr)}}
  @media(max-width:620px){.grid{grid-template-columns:repeat(3,1fr)}}
  .cardx{position:relative;aspect-ratio:3/4;border-radius:14px;cursor:pointer;transform-style:preserve-3d;transition:transform .35s ease}
  .cardx.lock{cursor:default}
  .face{position:absolute;inset:0;border-radius:14px;border:1px solid rgba(0,0,0,.12);backface-visibility:hidden;display:grid;place-items:center}
  .front{background:#fff;transform:rotateY(180deg)}
  .back{
    background:
      radial-gradient(circle at 20% 15%, rgba(255,255,255,.28), rgba(255,255,255,0) 35%),
      repeating-linear-gradient(45deg,#103f37 0 8px,#145247 8px 16px);
    border:1px solid rgba(0,0,0,.15);
  }
  .cardx.flip{transform:rotateY(180deg)}
  svg{width:80px;height:110px}
  .sil{opacity:.26;filter:grayscale(1) contrast(.9)}
  .glow{filter:drop-shadow(0 0 8px rgba(255,255,140,.9)) drop-shadow(0 0 18px rgba(255,255,140,.7))}

  .msg{margin-top:10px;border-radius:12px;padding:10px 12px;border:1px solid #e3eee9;background:#f8fffc;color:#0e4c41;display:none}
  .msg.show{display:block}
  .final{display:none;margin-top:14px;padding:14px;border-radius:14px;background:#f4fffb;border:1px solid #cfe6df}
  .flash{position:fixed;inset:0;pointer-events:none;background:radial-gradient(circle at 50% 45%,rgba(255,255,255,.9),rgba(255,255,255,0) 55%);opacity:0;transition:opacity .35s}
  .flash.on{opacity:1;animation:fadeFlash .9s ease forwards}
  @keyframes fadeFlash{0%{opacity:1}60%{opacity:.45}100%{opacity:0}}
  /* Libreta */
  .notes{margin-top:14px;border:1px solid #cfe6df;background:#ffffff;border-radius:12px;overflow:hidden}
  .notes .bar{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#eef7f5;border-bottom:1px solid #cfe6df}
  .notes .title{font-weight:700;color:#0c4a3f}
  .notes .body{padding:10px}
  .notes textarea{width:100%;min-height:110px;border:1px solid #cfe6df;border-radius:10px;padding:10px;resize:vertical}
  .notes .actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <button class="back" onclick="history.back()">← Volver a las pistas</button>
      <!-- Botón para ir al reloj de la verdad -->
<div style="margin-top:10px">
  <button class="btn primary" onclick="location.href='p06.html'">
    El reloj de la verdad
  </button>
</div>

      <h1>PISTA 5 — Memoria de agujas</h1>
    </div>

    <div class="card">
      <p><strong>Cómo se juega:</strong> hay un asesino entre sombras. Encuentra las parejas <strong>aguja + sombra</strong>. Cuando encajes bien, verás un destello y escucharás a Nora susurrar una idea. La <em>aguja de luz</em> también destella. Al final podrás pasar al <strong>Reloj de la verdad</strong>.</p>

      <div class="hud">
        <span class="pill" id="moves">Movimientos: 0</span>
        <span class="pill" id="fails">Fallos: 0</span>
        <span class="pill" id="time">Tiempo: 00:00</span>
        <button id="restart" class="btn ghost">Reiniciar</button>
      </div>

      <div id="board" class="grid" aria-label="Tablero de memoria"></div>

      <div id="feedback" class="msg"></div>

      <div id="finalBox" class="final"></div>

      <!-- Libreta -->
      <div class="notes" id="notes">
        <div class="bar">
          <div class="title">Libreta del caso</div>
          <div style="font-size:12px;color:#1a5c51">Tus notas se guardan en este dispositivo</div>
        </div>
        <div class="body">
          <textarea id="notesArea" placeholder="Anota detalles: horas, gestos, frases de Nora…"></textarea>
          <div class="actions">
            <button class="btn primary" id="saveLine">Guardar línea</button>
            <button class="btn ghost" id="undoLine">Borrar última línea</button>
            <button class="btn ghost" id="clearAll">Borrar todo</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="flash" class="flash"></div>

<script>
/* ===== util ===== */
const $=s=>document.querySelector(s);
const pad=n=>String(n).padStart(2,'0');

/* ===== generador de agujas (SVG) ===== */
function needleSVG({shaft=56, tip="arrow", weight="circle", thick=3, glow=false, shadow=false}={}){
  const w=90,h=120,cx=w/2,top=20,shaftH=shaft,bot=top+shaftH;
  const col = shadow ? "#0c2839" : "#0c2839";
  const op  = shadow ? ' class="sil"' : (glow ? ' class="glow"' : '');
  const frame = `<rect x="8" y="6" width="${w-16}" height="${h-12}" rx="10" fill="none" stroke="${shadow?'#21443f':'#1d4d46'}" stroke-width="2"/>`;
  const line  = `<rect x="${cx-thick/2}" y="${top}" width="${thick}" height="${shaftH}" rx="${thick/2}" fill="${col}"/>`;
  let tipEl="";
  if(tip==="arrow") tipEl=`<polygon points="${cx},${top-10} ${cx-8},${top+6} ${cx+8},${top+6}" fill="${col}"/>`;
  else if(tip==="needle") tipEl=`<rect x="${cx-(thick-1)/2}" y="${top-10}" width="${thick-1}" height="10" fill="${col}"/>`;
  else tipEl=`<polygon points="${cx},${top-9} ${cx-7},${top} ${cx},${top+9} ${cx+7},${top}" fill="${col}"/>`;
  let wgt="";
  if(weight==="circle") wgt=`<circle cx="${cx}" cy="${bot+10}" r="${6+Math.max(0,thick-3)}" fill="${col}"/>`;
  else if(weight==="spike") wgt=`<rect x="${cx-(thick+2)/2}" y="${bot}" width="${thick+2}" height="14" rx="2" fill="${col}"/>`;
  else wgt=`<circle cx="${cx}" cy="${bot+10}" r="8" fill="none" stroke="${col}" stroke-width="2"/>`;
  return `<svg viewBox="0 0 ${w} ${h}"${op}>${frame}${line}${tipEl}${wgt}</svg>`;
}

/* ===== modelos ===== */
const MODELS = [
  {shaft:58, tip:"arrow",  weight:"circle", thick:3},
  {shaft:62, tip:"diamond",weight:"spike",  thick:3},
  {shaft:54, tip:"needle", weight:"ring",   thick:4},
  {shaft:60, tip:"arrow",  weight:"ring",   thick:2},
  {shaft:52, tip:"diamond",weight:"circle", thick:4},
  {shaft:66, tip:"needle", weight:"spike",  thick:2},
  {shaft:56, tip:"arrow",  weight:"spike",  thick:4},
  {shaft:64, tip:"diamond",weight:"ring",   thick:3},
  {shaft:50, tip:"needle", weight:"circle", thick:3},
  {shaft:68, tip:"arrow",  weight:"circle", thick:2},
  {shaft:58, tip:"diamond",weight:"spike",  thick:5},
  {shaft:60, tip:"needle", weight:"ring",   thick:3, glow:true} // aguja de luz
];

/* ===== estado ===== */
const board=$("#board"), feedback=$("#feedback"), flash=$("#flash");
const movesEl=$("#moves"), failsEl=$("#fails"), timeEl=$("#time");
let first=null, second=null, lock=false, pairsFound=0, moves=0, fails=0, t0=null, tick=null;

const NORA_LINES = [
  "Nora: A veces la sombra se adelanta a la verdad.",
  "Nora: El detalle mínimo parte la noche en dos.",
  "Nora: Cuando encaja, el tiempo asiente.",
  "Nora: La memoria viaja al compás de la luz."
];

function build(){
  clearInterval(tick);
  board.innerHTML=""; feedback.className="msg"; feedback.textContent="";
  first=second=null; lock=false; pairsFound=0; moves=0; fails=0;
  movesEl.textContent="Movimientos: 0"; failsEl.textContent="Fallos: 0";
  // tiempo
  t0=Date.now(); timeEl.textContent="Tiempo: 00:00";
  tick=setInterval(()=>{ const s=Math.floor((Date.now()-t0)/1000); timeEl.textContent=`Tiempo: ${pad(Math.floor(s/60))}:${pad(s%60)}`; },1000);

  // baraja: para cada modelo, dos cartas: sombra y aguja
  const deck=[];
  MODELS.forEach((m,i)=>{
    deck.push({id:i, type:"shadow", html:needleSVG({...m, shadow:true})});
    deck.push({id:i, type:"needle", html:needleSVG(m)});
  });
  deck.sort(()=>Math.random()-.5);

  deck.forEach(card=>{
    const el=document.createElement("div");
    el.className="cardx"; el.tabIndex=0;
    el.dataset.id=card.id; el.dataset.type=card.type;
    el.innerHTML=`
      <div class="face front">${card.html}</div>
      <div class="face back"></div>
    `;
    el.addEventListener("click", ()=>flip(el));
    el.addEventListener("keydown", e=>{ if(e.key==="Enter"||e.key===" ") flip(el); });
    board.appendChild(el);
  });

  // Libreta: cargar
  loadNotes();
}

/* flip/match */
function flip(el){
  if(lock || el.classList.contains("flip") || el.classList.contains("lock")) return;
  el.classList.add("flip");
  if(!first){ first=el; return; }
  second=el; lock=true; moves++; movesEl.textContent=`Movimientos: ${moves}`;

  const match = first.dataset.id===second.dataset.id && first.dataset.type!==second.dataset.type;
  if(match){
    setTimeout(()=>{
      first.classList.add("lock");
      second.classList.add("lock");
      // fusion (deja solo aguja si era sombra)
      [first,second].forEach(x=>{
        if(x.dataset.type==="shadow"){
          x.querySelector(".front").innerHTML = needleSVG(MODELS[+x.dataset.id]);
        }
      });
      // flash + frase de Nora
      flash.classList.add("on"); setTimeout(()=>flash.classList.remove("on"), 360);
      feedback.className="msg show";
      feedback.textContent = NORA_LINES[Math.floor(Math.random()*NORA_LINES.length)];

      pairsFound++;
      resetPick();
      if(pairsFound===MODELS.length) finish();
    },260);
  } else {
    fails++; failsEl.textContent=`Fallos: ${fails}`;
    feedback.className="msg show"; feedback.textContent=["Observa la punta.","El contrapeso no coincide.","Grosor y longitud marcan la diferencia." ][Math.floor(Math.random()*3)];
    setTimeout(()=>{ first.classList.remove("flip"); second.classList.remove("flip"); resetPick(); },650);
  }
}

function resetPick(){ first=null; second=null; lock=false; }

/* FINAL */
function finish(){
  clearInterval(tick);
  const secs = Math.floor((Date.now()-t0)/1000);
  const final = document.getElementById("finalBox");
  // destello 1s más fuerte
  const f = document.getElementById("flash");
  f.classList.add("on"); setTimeout(()=>f.classList.remove("on"), 1000);

  final.style.display = "block";
  final.innerHTML = `
    <strong>¡Puzzle completo!</strong><br>
    Tiempo: <b>${pad(Math.floor(secs/60))}:${pad(secs%60)}</b> — Movimientos: <b>${moves}</b> — Fallos: <b>${fails}</b>.<br><br>
    <em>Nora:</em> «<strong>La memoria viaja al compás de la luz.</strong>»<br><br>
    <span style="display:block;margin:.3rem 0 1rem">Lo hemos resuelto, gracias a tus habilidades; ¡te espero en la próxima novela!</span>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn primary" onclick="location.href='p06.html'">El reloj de la verdad</button>
      <button class="btn ghost" onclick="history.back()">Volver al libro</button>
      <button class="btn ghost" onclick="build()">Volver a jugar</button>
    </div>
  `;
}

/* ===== Libreta (localStorage) ===== */
const KEY="notes_p05";
function loadNotes(){
  const area=$("#notesArea");
  const data=localStorage.getItem(KEY);
  area.value = data || "";
}
function saveLine(){
  const area=$("#notesArea");
  const val=area.value.trim();
  if(!val) return;
  area.value = val + (val.endsWith("\n")?"":"\n");
  localStorage.setItem(KEY, area.value);
}
function undoLine(){
  const area=$("#notesArea");
  const lines=area.value.split("\n");
  if(lines.length<=1){ area.value=""; localStorage.setItem(KEY,""); return;}
  lines.pop(); // línea vacía final
  lines.pop(); // última con texto
  area.value = lines.join("\n") + (lines.length? "\n": "");
  localStorage.setItem(KEY, area.value);
}
function clearAll(){
  if(confirm("¿Borrar todas las notas?")){ $("#notesArea").value=""; localStorage.removeItem(KEY); }
}
$("#saveLine").addEventListener("click", saveLine);
$("#undoLine").addEventListener("click", undoLine);
$("#clearAll").addEventListener("click", clearAll);

/* ===== go! ===== */
$("#restart").addEventListener("click", build);
build();
</script>
</body>
</html>












