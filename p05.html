<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pista 5 — El enigma de las agujas</title>
<style>
  :root{
    --fg:#f2f2f2;
    --fg-dim:#cfd3d7;
    --bg:#0c0c0f;
    --panel:#15171c;
    --panel-2:#111217;
    --brand:#89f6ff;
    --ok:#63ffb2;
    --err:#ff6b6b;
    --accent:#8ddcff;
    --slot-glow: rgba(137, 246, 255, .45);
  }
  *{ box-sizing: border-box; }
  html,body{ height:100%; background:#000; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Ubuntu, Cantarell, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"; color:var(--fg); }
  .wrap{
    min-height:100dvh;
    background:#000 url('./fondo.png') center top / cover no-repeat fixed;
  }
  .overlay{
    /* velo para subir brillo sobre el fondo y dar contraste de slots */
    background: linear-gradient( to bottom, rgba(18,20,25,.55), rgba(18,20,25,.65) 18%, rgba(18,20,25,.72) 28%, rgba(18,20,25,.9) 100%);
    backdrop-filter: saturate(120%) blur(1px);
  }
  .container{
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  h1{
    margin:0 0 14px 0;
    font-size: clamp(26px, 2.6vw, 36px);
    line-height:1.2;
  }
  .lead{ color:var(--fg-dim); font-size: clamp(16px, 1.7vw, 18px); }
  .toolbar{ display:flex; gap:12px; flex-wrap:wrap; margin: 18px 0 6px; }

  .btn{
    appearance:none; border:0; cursor:pointer; user-select:none;
    padding: 12px 18px; border-radius: 14px;
    background:#1b1f27; color:var(--fg); font-weight:700; letter-spacing:.2px;
    box-shadow: 0 0 0 1px rgba(255,255,255,.05) inset, 0 10px 30px rgba(0,0,0,.25);
    transition: transform .1s ease, background .2s ease, box-shadow .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); background:#202634; }
  .btn:active{ transform: translateY(0); }
  .btn--ghost{ background:transparent; box-shadow: 0 0 0 1px rgba(255,255,255,.15) inset; }
  .btn--brand{ background: linear-gradient(90deg, #4cc9f0, #4895ef); }
  .btn--brand:hover{ background: linear-gradient(90deg, #56e0ff, #5aa4ff); }

  .grid{
    display:grid; gap:18px;
    grid-template-columns: 1.25fr 1fr;
    margin: 22px 0 40px;
  }

  .panel{
    background: rgba(20,22,27,.72);
    border-radius: 18px;
    padding: 18px;
    box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset, 0 10px 40px rgba(0,0,0,.35);
  }
  .panel h2{
    margin:0 0 10px; font-size: clamp(18px,1.9vw,21px); color:var(--fg);
  }

  /* ZONA RANURAS (izquierda) */
  .slots{
    display:grid;
    gap: 12px;
    grid-template-columns: repeat(3, 1fr);
  }
  .slot{
    position:relative;
    border-radius: 16px;
    padding: 10px;
    aspect-ratio: 1 / 1.35; /* vertical */
    background:
      radial-gradient(100px 40px at 50% 15%, rgba(255,255,255,.08), transparent 50%),
      rgba(11,12,16,.65);
    box-shadow:
      0 0 0 1px rgba(255,255,255,.06) inset,
      0 10px 30px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .slot::after{
    /* halo suave para “levantar” la ranura sobre el fondo */
    content:'';
    position:absolute; inset:-1px;
    border-radius:16px;
    box-shadow: 0 0 0 2px rgba(255,255,255,.06) inset, 0 0 0 8px rgba(255,255,255,.02) inset;
    pointer-events:none;
  }
  .slot.is-target{ outline: 2px solid var(--slot-glow); box-shadow: 0 0 0 6px rgba(137,246,255,.08) inset; }
  .slot.locked{ background: rgba(20,90,60,.14); }
  .ghost{
    /* “sombra” clara: la misma aguja con filtros para que se intuya */
    width: 100%;
    height: 100%;
    background-position: center;
    background-repeat: no-repeat;
    background-size: contain;
    filter: grayscale(100%) brightness(.95) contrast(110%) opacity(.30);
    mix-blend-mode: screen;
  }
  .placed{
    position:absolute; inset:10px;
    background-position:center;
    background-repeat:no-repeat;
    background-size:contain;
    filter: drop-shadow(0 12px 12px rgba(0,0,0,.45));
    pointer-events:none;
  }

  /* ZONA PIEZAS (derecha) */
  .library{
    display:grid; gap:12px;
    grid-template-columns: repeat(2, 1fr);
  }
  .piece{
    border-radius: 14px;
    background: rgba(14,16,20,.78);
    box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset, 0 10px 30px rgba(0,0,0,.35);
    padding: 12px;
    aspect-ratio: 1 / 1.35;
    cursor: pointer;
    position:relative;
    transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
  }
  .piece:hover{ transform: translateY(-1px); background: rgba(18,21,27,.9); }
  .piece:active{ transform: translateY(0); }
  .piece.is-selected{ outline: 2px solid var(--accent); box-shadow: 0 0 0 8px rgba(137,246,255,.08) inset; }

  .piece .img{
    position:absolute; inset:12px;
    background-position: center;
    background-repeat: no-repeat;
    background-size: contain;
  }

  /* CAJA MENSAJES */
  .messages{
    margin: -6px 0 30px;
    padding: 14px 16px;
    border-radius: 12px;
    background: rgba(8,10,12,.6);
    box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
    min-height: 52px;
    display:flex; align-items:center;
    color: var(--fg);
    font-size: clamp(14px, 1.6vw, 16px);
  }
  .msg-ok{ color: var(--ok); }
  .msg-err{ color: var(--err); }
  .msg-info{ color: var(--fg-dim); }

  /* DESTELLO */
  .flash{
    position: fixed; inset: 0;
    pointer-events: none;
    background: radial-gradient(600px 300px at 50% 40%, rgba(140,220,255,.85), transparent 70%);
    opacity: 0; transition: opacity .4s ease;
  }
  .flash.show{ opacity: 1; animation: fadeFlash .9s ease forwards; }
  @keyframes fadeFlash{
    0%{ opacity: 0; }
    20%{ opacity: 1; }
    100%{ opacity: 0; }
  }

  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
    .library{ grid-template-columns: repeat(3, 1fr); }
    .slots{ grid-template-columns: repeat(3, 1fr); }
  }
  @media (max-width: 560px){
    .library{ grid-template-columns: repeat(2, 1fr); }
    .slots{ grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>
<div class="wrap overlay">
  <div class="container">
    <header>
      <h1>PISTA 5 — El enigma de las agujas</h1>
      <p class="lead">
        Arrastra o toca una <strong>aguja</strong> de la biblioteca y colócala en su <strong>ranura</strong> (verás su silueta). Tienes
        <strong>3 intentos por ranura</strong>. Si fallas demasiadas veces en cualquiera, el juego se reinicia. Cuando coloques la
        <em>aguja de luz</em> verás un destello y aparecerá la pista final.
      </p>
      <div class="toolbar">
        <button class="btn btn--ghost" id="btnBack">← Volver a las pistas</button>
        <button class="btn btn--brand" id="btnDamas">Jugar al tablero de damas</button>
      </div>
    </header>

    <div id="messages" class="messages msg-info">Empieza cuando quieras. Selecciona una aguja y toca la ranura donde crees que encaja.</div>

    <section class="grid">
      <div class="panel">
        <h2>Ranuras (sombras)</h2>
        <div id="slots" class="slots"></div>
      </div>

      <div class="panel">
        <h2>Biblioteca de agujas</h2>
        <div id="library" class="library"></div>
      </div>
    </section>
  </div>
</div>

<div id="flash" class="flash" aria-hidden="true"></div>

<script>
(() => {
  /* ========= CONFIG ========= */
  const NEEDLES = [
    "aguja01.png","aguja02.png","aguja03.png","aguja04.png","aguja05.png","aguja06.png",
    "aguja07.png","aguja08.png","aguja09.png","aguja10.png","aguja11.png","aguja_luz.png" // especial
  ];
  const SPECIAL_NAME = "aguja_luz.png";  // hará destello + mensaje
  const MAX_TRIES_PER_SLOT = 3;

  /* ========= STATE ========= */
  let selectedPiece = null;          // nombre fichero aguja seleccionada
  let solvedCount = 0;               // cuántas ranuras completadas
  let triesBySlot = {};              // idSlot -> intentos consumidos
  let isLocked = false;              // para evitar doble click durante animación

  /* ========= DOM ========= */
  const $library = document.getElementById('library');
  const $slots   = document.getElementById('slots');
  const $msg     = document.getElementById('messages');
  const $flash   = document.getElementById('flash');

  /* ========= HELPERS ========= */
  const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);
  const say = (txt, cls='msg-info') => { $msg.className = 'messages ' + cls; $msg.textContent = txt; }

  const ENCOURAGE = [
    "Sigue probando, la forma es la clave.",
    "Pista: fíjate en la punta y la base.",
    "Cerca… compara el contorno del marco.",
    "¡Ánimo! Cada error te acerca a la solución.",
    "Recuerda: algunas son muy finas y otras más barrocas."
  ];
  const finalHint = "“Soy Nora y estoy segura de que la pista es la misma que la mía”.";
  const failAll   = "Demasiados fallos en una ranura. El enigma se reinicia desde el principio.";

  /* ========= BUILD SLOTS ========= */
  const buildSlots = () => {
    $slots.innerHTML = '';
    triesBySlot = {};
    solvedCount = 0;
    // Para orden estable (y poder ser puzzle), usaremos los 12 nombres en un orden fijo:
    const order = NEEDLES.slice(); // misma lista, pero la sombra es “su” solución
    order.forEach((file, idx) => {
      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.dataset.answer = file;     // archivo correcto
      slot.dataset.slotId = 's'+idx;
      triesBySlot[slot.dataset.slotId] = 0;

      // fondo “sombra” usando el mismo png pero con filtro
      const ghost = document.createElement('div');
      ghost.className = 'ghost';
      ghost.style.backgroundImage = `url('./${file}')`;
      slot.appendChild(ghost);

      // click para intentar colocar
      slot.addEventListener('click', () => tryPlace(slot));

      $slots.appendChild(slot);
    });
  };

  /* ========= BUILD LIBRARY ========= */
  const buildLibrary = () => {
    $library.innerHTML = '';
    const mix = shuffle(NEEDLES.slice());
    mix.forEach(file => {
      const box = document.createElement('div');
      box.className = 'piece';
      box.setAttribute('tabindex', '0');
      box.dataset.file = file;

      const img = document.createElement('div');
      img.className = 'img';
      img.style.backgroundImage = `url('./${file}')`;
      box.appendChild(img);

      const select = () => {
        if (isLocked) return;
        // toggle selección
        [...$library.querySelectorAll('.piece')].forEach(p=>p.classList.remove('is-selected'));
        if (selectedPiece === file) {
          selectedPiece = null;
          say("Sin selección. Toca una aguja y después una ranura.");
        } else {
          selectedPiece = file;
          box.classList.add('is-selected');
          say("Aguja seleccionada. Ahora toca la ranura correcta.");
        }
      };
      box.addEventListener('click', select);
      box.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') select(); });

      $library.appendChild(box);
    });
  };

  /* ========= PLACE LOGIC ========= */
  const tryPlace = (slot) => {
    if (isLocked) return;
    if (slot.classList.contains('locked')) return;
    if (!selectedPiece) { say("Primero selecciona una aguja de la biblioteca.", 'msg-info'); return; }

    const answer = slot.dataset.answer;
    const slotId = slot.dataset.slotId;

    if (selectedPiece === answer) {
      // OK
      placeInSlot(slot, selectedPiece);
    } else {
      // ERROR
      triesBySlot[slotId] += 1;
      const left = MAX_TRIES_PER_SLOT - triesBySlot[slotId];
      if (left <= 0) {
        // reiniciar todo
        say(failAll, 'msg-err');
        resetPuzzle();
      } else {
        const msg = ENCOURAGE[Math.floor(Math.random()*ENCOURAGE.length)];
        say(`${msg} (${left} intento${left===1?'':'s'} restantes en esta ranura)`, 'msg-err');
        // feedback visual
        slot.classList.add('is-target');
        setTimeout(()=> slot.classList.remove('is-target'), 350);
      }
    }
  };

  const placeInSlot = (slot, file) => {
    isLocked = true;

    // Mostrar pieza “puesta”
    const done = document.createElement('div');
    done.className = 'placed';
    done.style.backgroundImage = `url('./${file}')`;
    slot.appendChild(done);
    slot.classList.add('locked');

    // Quitar de biblioteca y limpiar selección
    const node = $library.querySelector(`.piece[data-file="${file}"]`);
    if (node) node.remove();
    selectedPiece = null;

    // Si es la aguja especial: destello + mensaje
    if (file === SPECIAL_NAME) {
      flash();
      setTimeout(()=> say(finalHint, 'msg-ok'), 260);
    } else {
      say("¡Bien! Sigue encajando las agujas.", 'msg-ok');
    }

    solvedCount += 1;
    isLocked = false;

    if (solvedCount === NEEDLES.length) {
      setTimeout(()=> say("¡Puzzle completado! La aguja especial ya te dio la pista final.", 'msg-ok'), 80);
    }
  };

  const resetPuzzle = () => {
    // pequeña pausa para que se lea el mensaje
    isLocked = true;
    setTimeout(()=>{
      isLocked = false;
      buildSlots();
      buildLibrary();
      say("Juego reiniciado. Vuelve a intentarlo con calma.", 'msg-info');
    }, 650);
  };

  const flash = () => {
    $flash.classList.add('show');
    setTimeout(()=> $flash.classList.remove('show'), 900);
  };

  /* ========= DAMAS (ventana nueva auto-generada) ========= */
  const openDamas = () => {
    const html = `
<!DOCTYPE html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tablero de damas</title>
<style>
  body{margin:0;background:#0b1015;color:#e8eef4;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .toolbar{display:flex;gap:12px;margin-bottom:16px}
  .btn{border:0;border-radius:12px;padding:10px 16px;background:#1a2230;color:#e8eef4;cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}
  .panel{background:#121821;border-radius:16px;box-shadow:0 0 0 1px rgba(255,255,255,.06) inset;padding:18px}
  h1{margin:0 0 10px}
  .board{--s:72px;display:grid;grid-template-columns:repeat(8,var(--s));grid-auto-rows:var(--s);box-shadow:0 10px 30px rgba(0,0,0,.35);border-radius:10px;overflow:hidden}
  .sq{display:flex;align-items:center;justify-content:center;font-weight:700}
  .dark{background:#134a2f} .light{background:#d2edd7;color:#0b1015}
  .piece{width:64%;height:64%;border-radius:50%;box-shadow:0 8px 14px rgba(0,0,0,.35) inset}
  .P{background:#28324a} .M{background:#b44a3f}
  .msg{margin-top:12px;padding:10px 12px;border-radius:10px;background:#0d131a}
  @media (max-width:680px){ .board{--s:38px} .grid{grid-template-columns:1fr} }
</style>
<div class="wrap">
  <div class="toolbar">
    <button class="btn" onclick="window.close()">← Cerrar</button>
  </div>
  <div class="grid">
    <div class="panel">
      <h1>Tablero de damas</h1>
      <div id="board" class="board"></div>
      <div id="msg" class="msg">Las pistas pueden estar en todos ellos, pero solo uno sabe la verdad.</div>
    </div>
    <div class="panel">
      <h2>Instrucciones (demo)</h2>
      <p>Este es un tablero ilustrativo para acompañar la pista. La “máquina” hace dos jugadas y te deja ganar en la tercera, para que el lector termine en alto.</p>
      <ol>
        <li>Haz clic sobre una ficha azul (jugador) y luego sobre una casilla clara adyacente para mover.</li>
        <li>La máquina (rojas) moverá automáticamente tras tu movimiento.</li>
        <li>En la tercera ronda, se forzará tu victoria.</li>
      </ol>
    </div>
  </div>
</div>
<script>
(() => {
  const $b = document.getElementById('board');
  const $m = document.getElementById('msg');

  // Montamos 8x8 con patrón damas
  const squares=[];
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const s=document.createElement('div');
      s.className='sq '+(((r+c)%2)?'light':'dark');
      s.dataset.r=r; s.dataset.c=c;
      $b.appendChild(s);
      squares.push(s);
    }
  }

  // Colocar 6 fichas jugador (azules) y 6 máquina (rojas) simplificadas
  const P = []; const M=[];
  const place=(r,c,cls)=>{ const p=document.createElement('div'); p.className='piece '+cls; get(r,c).appendChild(p); return p; };
  const get=(r,c)=>squares[r*8+c];

  [[5,1],[5,3],[5,5],[6,0],[6,2],[6,4]].forEach(([r,c])=>P.push(place(r,c,'P')));
  [[1,2],[1,4],[1,6],[2,1],[2,3],[2,5]].forEach(([r,c])=>M.push(place(r,c,'M')));

  let selected=null, moves=0, locked=false;

  $b.addEventListener('click',(e)=>{
    if(locked) return;
    const cell = e.target.closest('.sq');
    if(!cell) return;
    const hasP = cell.querySelector('.P');

    if(hasP){ // seleccionar
      selected = cell;
      $m.textContent="Has seleccionado una ficha azul. Toca una casilla clara adyacente para mover.";
      return;
    }
    if(selected){
      // mover solo a casilla clara vacía y adyacente (demo)
      if(!cell.classList.contains('light') || cell.childElementCount) { $m.textContent="Movimiento no válido."; selected=null; return; }
      const r0 = +selected.dataset.r, c0=+selected.dataset.c;
      const r1 = +cell.dataset.r,     c1=+cell.dataset.c;
      if(Math.abs(r1-r0)===1 && Math.abs(c1-c0)===1){
        cell.appendChild(selected.querySelector('.P'));
        selected=null; moves++;
        // turno máquina (dos jugadas tontas) y a la tercera te deja ganar
        setTimeout(()=>aiMove(),420);
      }else{ $m.textContent="Solo un paso en diagonal."; selected=null; }
    }
  });

  function aiMove(){
    if(moves<2){
      // máquina mueve una cualquiera 1 paso si puede (muy simple)
      for(const m of M){
        const cell = m.parentElement, r=+cell.dataset.r, c=+cell.dataset.c;
        const d = [[1,-1],[1,1]];
        for(const [dr,dc] of d){
          const rr=r+dr, cc=c+dc;
          if(rr<0||rr>7||cc<0||cc>7) continue;
          const dst = get(rr,cc);
          if(dst.classList.contains('light') && !dst.childElementCount){
            dst.appendChild(m); $m.textContent="La máquina piensa…"; return;
          }
        }
      }
      $m.textContent="Las pistas pueden estar en todos ellos, pero solo uno sabe la verdad.";
    }else{
      // Te deja ganar: elimina una roja y muestra mensaje final
      if(M[0] && M[0].parentElement) M[0].parentElement.removeChild(M[0]);
      $m.textContent="Al final has descubierto quién es el asesino. Ahora te espero en el próximo caso…";
    }
  }
})();
</script>
</html>`;
    const blob = new Blob([html], {type:'text/html'});
    const url  = URL.createObjectURL(blob);
    window.open(url, '_blank', 'noopener,noreferrer');
  };

  /* ========= INIT ========= */
  const init = () => {
    buildSlots();
    buildLibrary();
    say("Empieza cuando quieras. Selecciona una aguja y luego una ranura.", 'msg-info');

    // botones
    document.getElementById('btnBack').addEventListener('click', () => {
      // Ajusta al destino real de “pistas”
      location.href = 'index.html';
    });
    document.getElementById('btnDamas').addEventListener('click', openDamas);
  };

  init();
})();
</script>
</body>
</html>







