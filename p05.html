<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pista 5 ‚Äî Enigma de las agujas + Tablero de damas (demo)</title>
<style>
  :root{
    --bg-overlay: rgba(0,0,0,.65);
    --card: rgba(20,20,20,.75);
    --text: #e8f1ed;
    --muted: #b9c7bf;
    --accent: #59c1ff;
    --ok: #69e781;
    --bad: #ff7a7a;
    --warning: #ffda6b;
    --green-dark: #0e3a28;
    --green-light: #dff5e8;
  }
  /* ====== LAYOUT Y FONDO ====== */
  html,body{
    height:100%;
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    color:var(--text);
    background: var(--bg-overlay);
  }
  body::before{
    content:"";
    position:fixed; inset:0;
    background: url("fondo.png") center/cover no-repeat #111;
    z-index:-2;
    filter: saturate(1.05);
  }
  body::after{
    content:"";
    position:fixed; inset:0;
    background: radial-gradient(60% 60% at 50% 10%, rgba(0,0,0,.25), rgba(0,0,0,.75));
    z-index:-1;
  }
  .wrap{
    max-width: 1100px;
    margin: 24px auto 80px;
    padding: 0 16px;
  }
  .header{
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    margin-bottom: 16px;
  }
  h1{ margin:0; font-size: clamp(26px, 3.8vw, 42px); letter-spacing:.2px;}
  .pill{
    background: rgba(255,255,255,.08);
    padding: 8px 12px;
    border-radius: 999px;
    color: var(--muted);
    border: 1px solid rgba(255,255,255,.1);
  }
  .btn{
    appearance:none; border:0; cursor:pointer;
    background: #39a1ff; color:#071521; font-weight:600;
    padding:10px 14px; border-radius:12px;
    transition: transform .06s ease, box-shadow .2s ease, background .15s ease;
    box-shadow: 0 6px 24px rgba(57,161,255,.25);
  }
  .btn.secondary{ background:#283341; color:#d9e6f5; box-shadow:none; }
  .btn:active{ transform: translateY(1px); }

  .card{
    background: var(--card);
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px;
    padding:18px;
    box-shadow: 0 10px 40px rgba(0,0,0,.35);
    margin-top:14px;
  }
  .row{ display:grid; gap:18px; grid-template-columns:1fr; }
  @media(min-width: 920px){ .row{ grid-template-columns: 1.2fr .8fr; } }

  /* ====== ENIGMA DE LAS AGUJAS ====== */
  .areas{
    display:grid; gap:18px;
    grid-template-columns: 1fr 1fr;
  }
  @media(max-width: 800px){ .areas{ grid-template-columns: 1fr; } }

  .panel-title{ font-size:22px; margin:4px 0 14px; }
  .slots, .library{
    background: rgba(255,255,255,.03);
    border:1px dashed rgba(255,255,255,.12);
    border-radius:16px; padding:16px;
    min-height: 260px;
    display:grid; grid-template-columns: repeat(3,minmax(90px,1fr));
    gap:14px;
  }
  .slot, .needle{
    position:relative;
    display:flex; align-items:center; justify-content:center;
    border-radius:14px; overflow:hidden;
    background: rgba(255,255,255,.02);
    border:1px solid rgba(255,255,255,.08);
    min-height: 120px;
  }
  /* SOMBRA (silhueta) MUCHO M√ÅS CLARA */
  .slot::before{
    content:"";
    position:absolute; inset:10px;
    background: radial-gradient(ellipse at 50% 15%, rgba(255,255,255,.15), rgba(0,0,0,.10) 45%, rgba(0,0,0,0) 70%);
    filter: blur(2px);
    opacity:.55;    /* <<<<< sombra clara (antes no se ve√≠a) */
    pointer-events:none;
  }
  .slot.is-target{
    outline: 2px solid var(--accent);
    box-shadow: 0 0 0 6px rgba(57,161,255,.15) inset;
  }
  .slot.correct{
    outline: 2px solid var(--ok);
    box-shadow: 0 0 0 6px rgba(105,231,129,.18) inset;
  }
  .slot.fail{
    outline: 2px solid var(--bad);
    box-shadow: 0 0 0 6px rgba(255,122,122,.18) inset;
  }
  .needle{
    background: rgba(255,255,255,.04);
    cursor:grab;
    transition: transform .08s ease;
  }
  .needle:active{ cursor:grabbing; transform: scale(.98); }
  .needle img{
    max-width: 70px; max-height: 90px; object-fit: contain; filter: drop-shadow(0 4px 10px rgba(0,0,0,.5));
  }
  .hint{ color: var(--muted); margin: 8px 0 0; font-size: 14px; }

  .flash{
    position: fixed; inset:0; pointer-events:none;
    background: radial-gradient(circle at 50% 45%, rgba(255,255,255,.85), rgba(255,255,255,0) 55%);
    opacity:0; transition: opacity .35s ease;
  }
  .flash.on{ opacity:1; animation: fadeFlash .9s ease forwards; }
  @keyframes fadeFlash{ 0%{opacity:1} 60%{opacity:.4} 100%{opacity:0} }

  .final-msg{
    display:none;
    margin-top:12px; padding:14px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
  }

  /* ====== TABLERO DE DAMAS (DEMO) ====== */
  .board-wrap{ display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
  @media(max-width: 980px){ .board-wrap{ grid-template-columns: 1fr; } }

  .board{
    width:100%; aspect-ratio: 1/1; max-width: 640px;
    margin:auto; border-radius:18px; overflow:hidden;
    border:1px solid rgba(255,255,255,.1);
    box-shadow: 0 16px 40px rgba(0,0,0,.45);
  }
  .grid{
    display:grid; grid-template-columns: repeat(8,1fr);
    width:100%; height:100%;
  }
  .sq{
    display:flex; align-items:center; justify-content:center;
    font-size:12px;
    user-select:none;
  }
  .sq.dark{ background:#0c3a28; }
  .sq.light{ background:#e2f6ea; }
  .piece{
    width:min(68px, 9.6vmin); height:min(68px, 9.6vmin);
    border-radius:50%;
    display:grid; place-items:center;
    font-weight:700; text-align:center;
    cursor:pointer; user-select:none;
    border: 3px solid rgba(0,0,0,.35);
    box-shadow: 0 10px 24px rgba(0,0,0,.35);
  }
  .piece.player{
    background: #1e7f58; color:#cfeee1;  /* VERDE */
  }
  .piece.ai{
    background: #b84239; color:#ffe9e7;  /* ROJO */
  }
  .piece .label{
    font-size: clamp(10px, 1.6vw, 14px);
    line-height:1.1;
    opacity:.95;
    text-shadow: 0 1px 0 rgba(0,0,0,.4);
  }
  .sq.target{ outline: 3px solid var(--warning); box-shadow: inset 0 0 0 6px rgba(255,218,107,.25); }
  .status{
    font-size:15px; color:var(--muted);
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    padding:12px; margin-top:10px;
  }
  .banner{
    position:fixed; left:50%; bottom:24px; transform: translateX(-50%);
    background: rgba(20,20,20,.9);
    border:1px solid rgba(255,255,255,.12);
    color:var(--text);
    padding:12px 16px; border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.5);
    display:none;
  }
  .banner.show{ display:block; }

  .overlay{
    position:fixed; inset:0; display:none; place-items:center;
    background: rgba(0,0,0,.7);
    z-index:50;
  }
  .overlay .modal{
    width:min(600px, 92vw);
    background: #0f1a16;
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px; padding:16px 18px 18px;
    box-shadow: 0 30px 80px rgba(0,0,0,.6);
  }
  .overlay.show{ display:grid; }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>PISTA 5 ‚Äî El enigma de las agujas</h1>
    <span class="pill">Arrastra una aguja a su ranura. 3 intentos por ranura.</span>
    <button id="openCheckers" class="btn">Jugar al tablero de damas</button>
  </div>

  <div class="card">
    <p>Empieza cuando quieras. Selecciona una aguja y luego una ranura. Cuando coloques la <em>aguja de luz</em> ver√°s un destello y aparecer√° la pista final.</p>

    <div class="areas">
      <section>
        <div class="panel-title">Ranuras (sombras)</div>
        <div id="slots" class="slots" aria-label="ranuras">
          <!-- Slots se crean por JS -->
        </div>
        <p class="hint">Sombra clara para que las veas bien üòâ</p>
      </section>

      <section>
        <div class="panel-title">Biblioteca de agujas</div>
        <div id="library" class="library" aria-label="biblioteca">
          <!-- Agujas se crean por JS -->
        </div>
        <p class="hint">Consejo: hay una ‚Äúaguja de luz‚Äù. Si aciertas su ranura, aparece el destello.</p>
      </section>
    </div>

    <div id="finalClue" class="final-msg"></div>
  </div>

  <!-- ====== TABLERO DE DAMAS (overlay) ====== -->
  <div id="checkersOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Tablero de damas">
    <div class="modal">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
        <h2 style="margin:0">Tablero de damas</h2>
        <button id="closeCheckers" class="btn secondary">Cerrar</button>
      </div>

      <div class="board-wrap" style="margin-top:10px">
        <div>
          <div id="board" class="board">
            <div id="grid" class="grid"></div>
          </div>
          <div id="status" class="status">Haz clic en una ficha <strong>verde</strong> (jugador) y luego en una casilla clara adyacente. La m√°quina mover√° autom√°ticamente. En las dos primeras partidas gana la m√°quina; en la tercera te dejar√° ganar y ver√°s el mensaje de Nora.</div>
        </div>
        <div class="card" style="margin:0">
          <h3 style="margin:6px 0 8px">Instrucciones (demo)</h3>
          <ol style="margin:0 0 8px 18px">
            <li>Selecciona una ficha verde con nombre (Tom√°s, Nora, Arturo, Daniel‚Ä¶)</li>
            <li>Mueve a una casilla clara adyacente.</li>
            <li>La m√°quina (rojas) responder√°.</li>
            <li>Partida 1 y 2: gana la m√°quina.</li>
            <li>Partida 3: ¬°te deja ganar! Aparece el mensaje final de Nora.</li>
          </ol>
          <button id="resetDemo" class="btn">Reiniciar demo</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="banner"></div>
</div>

<div class="flash" id="flash"></div>

<script>
/* =========================
   UTILIDADES
========================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function toast(msg, ms=1600){
  const el = $("#toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=> el.classList.remove("show"), ms);
}

/* =========================
   ENIGMA DE LAS AGUJAS
========================= */
(function needlesGame(){
  // Configura aqu√≠ los nombres/ids y cu√°l es la "aguja de luz"
  const NEEDLES = [
    { id:"aguja01", img:"aguja01.png", name:"Aguja fina" },
    { id:"aguja02", img:"aguja02.png", name:"Aguja curva" },
    { id:"aguja03", img:"aguja03.png", name:"Aguja de luz" } // << especial
  ];
  const LIGHT_ID = "aguja03";

  const slotsEl = $("#slots");
  const libEl = $("#library");
  const finalBox = $("#finalClue");
  const flash = $("#flash");

  // Crear 3 ranuras
  const slotState = {};
  NEEDLES.forEach(n=>{
    const s = document.createElement("div");
    s.className = "slot";
    s.dataset.accept = n.id;           // ranura correcta
    s.dataset.tries = "0";
    s.setAttribute("aria-label", "ranura para " + n.name);
    s.addEventListener("dragover", e=>{ e.preventDefault(); s.classList.add("is-target"); });
    s.addEventListener("dragleave", ()=> s.classList.remove("is-target"));
    s.addEventListener("drop", e=>{
      e.preventDefault();
      s.classList.remove("is-target");
      const draggedId = e.dataTransfer.getData("text/needle");
      handleDrop(s, draggedId);
    });
    slotsEl.appendChild(s);
    slotState[n.id] = { placed:false, tries:0 };
  });

  // Crear biblioteca
  NEEDLES.forEach(n=>{
    const d = document.createElement("div");
    d.className = "needle";
    d.draggable = true;
    d.dataset.id = n.id;
    d.title = n.name;
    d.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/needle", n.id);
    });
    // Imagen (si no existe, igual se ver√° vac√≠o pero se podr√° arrastrar)
    const img = document.createElement("img");
    img.src = n.img;
    img.alt = n.name;
    d.appendChild(img);
    libEl.appendChild(d);
  });

  function handleDrop(slot, draggedId){
    const accept = slot.dataset.accept;
    const st = slotState[accept];
    if(st.placed) { toast("Esa ranura ya est√° resuelta"); return; }

    st.tries++;
    slot.dataset.tries = String(st.tries);

    if(draggedId === accept){
      st.placed = true;
      slot.classList.remove("fail");
      slot.classList.add("correct");
      toast("¬°Correcto!");
      if(draggedId === LIGHT_ID){
        flash.classList.add("on");
        setTimeout(()=> flash.classList.remove("on"), 900);
        showFinalClue();
      }
      // mover la aguja visualmente dentro
      const img = document.createElement("img");
      img.src = NEEDLES.find(n=>n.id===draggedId)?.img || "";
      img.style.maxWidth = "70px";
      img.style.maxHeight = "90px";
      slot.innerHTML = "";
      slot.appendChild(img);
    } else {
      slot.classList.add("fail");
      setTimeout(()=> slot.classList.remove("fail"), 700);
      toast("No encaja. Intento " + st.tries + " de 3");
      if(st.tries >= 3){
        toast("Demasiados intentos en esta ranura. El juego se reinicia.", 2000);
        setTimeout(resetNeedles, 900);
      }
    }
  }

  function resetNeedles(){
    slotsEl.innerHTML = "";
    libEl.innerHTML = "";
    finalBox.style.display = "none";
    finalBox.innerHTML = "";
    flash.classList.remove("on");
    NEEDLES.forEach(n=> slotState[n.id] = { placed:false, tries:0 });
    // reconstruir
    NEEDLES.forEach(n=>{
      const s = document.createElement("div");
      s.className = "slot";
      s.dataset.accept = n.id;
      s.dataset.tries = "0";
      s.addEventListener("dragover", e=>{ e.preventDefault(); s.classList.add("is-target"); });
      s.addEventListener("dragleave", ()=> s.classList.remove("is-target"));
      s.addEventListener("drop", e=>{
        e.preventDefault();
        s.classList.remove("is-target");
        const draggedId = e.dataTransfer.getData("text/needle");
        handleDrop(s, draggedId);
      });
      slotsEl.appendChild(s);
    });
    NEEDLES.forEach(n=>{
      const d = document.createElement("div");
      d.className = "needle";
      d.draggable = true;
      d.dataset.id = n.id;
      d.title = n.name;
      d.addEventListener("dragstart", e=>{
        e.dataTransfer.setData("text/needle", n.id);
      });
      const img = document.createElement("img");
      img.src = n.img;
      img.alt = n.name;
      d.appendChild(img);
      libEl.appendChild(d);
    });
  }

  function showFinalClue(){
    finalBox.style.display = "block";
    finalBox.innerHTML = `
      <strong>¬°Pista final desbloqueada!</strong><br>
      ‚ÄúEl brillo no viene del metal, sino de quien lo empu√±a. ‚ÄîNora‚Äù
    `;
  }
})();

/* =========================
   TABLERO DE DAMAS ‚Äî DEMO
   (reglas m√≠nimas para el efecto que pides)
========================= */
(function checkersDemo(){
  const overlay = $("#checkersOverlay");
  const openBtn = $("#openCheckers");
  const closeBtn = $("#closeCheckers");
  const resetBtn = $("#resetDemo");
  const grid = $("#grid");
  const status = $("#status");

  // 8x8
  const SIZE = 8;
  // Posiciones m√≠nimas para la demo (filas 0 arriba)
  let round = 1;           // Partida 1 y 2 gana IA; 3 gana jugador
  let selected = null;     // {r,c}
  let pieces = null;       // { player: Set("r,c"), ai: Set("r,c") }

  const names = ["Tom√°s","Nora","Arturo","Daniel","Sof√≠a","Luc√≠a","Mario","Eva"];

  openBtn.addEventListener("click", ()=>{ overlay.classList.add("show"); initBoard(); });
  closeBtn.addEventListener("click", ()=> overlay.classList.remove("show"));
  resetBtn.addEventListener("click", ()=> { round=1; initBoard(true); });

  function initBoard(resetText=false){
    grid.innerHTML = "";
    selected = null;
    pieces = {
      // 4 fichas de jugador en la fila 6 (verdes)
      player: new Set(["6,1","6,3","6,5","6,7"]),
      // 5 fichas IA en filas 1 y 2 (rojas)
      ai: new Set(["1,2","1,4","1,6","2,3","2,5"])
    };
    if(resetText){
      status.innerHTML = "Demo reiniciada. En las dos primeras partidas gana la m√°quina; en la tercera te deja ganar y ver√°s el mensaje de Nora.";
    }
    draw();
  }

  function draw(){
    grid.innerHTML = "";
    for(let r=0;r<SIZE;r++){
      for(let c=0;c<SIZE;c++){
        const dark = (r+c)%2===1;
        const cell = document.createElement("div");
        cell.className = "sq " + (dark ? "dark":"light");
        cell.dataset.r = r; cell.dataset.c = c;

        // Piezas
        const key = `${r},${c}`;
        if(pieces.player.has(key)){
          cell.appendChild(makePiece("player", labelFor(key)));
        } else if(pieces.ai.has(key)){
          cell.appendChild(makePiece("ai"));
        }

        // Eventos
        cell.addEventListener("click", ()=> onSquareClick(r,c));
        grid.appendChild(cell);
      }
    }
    markTargets();
  }

  function labelFor(key){
    // Asigna nombres a las 4 verdes
    const order = ["6,1","6,3","6,5","6,7"];
    const idx = Math.max(0, order.indexOf(key));
    return names[idx] || "Jugador";
  }

  function makePiece(type, name=""){
    const d = document.createElement("div");
    d.className = "piece " + type;
    const span = document.createElement("div");
    span.className = "label";
    span.textContent = type==="player" ? (name||"") : "‚óè";
    d.appendChild(span);
    return d;
  }

  function onSquareClick(r,c){
    const key = `${r},${c}`;
    if(pieces.player.has(key)){
      // seleccionar
      selected = { r, c };
      draw();
      return;
    }
    // Si hay selecci√≥n y la casilla es clara adyacente y vac√≠a => mover
    if(selected && isLight(r,c) && isAdjacent(selected.r,selected.c,r,c) && isEmpty(r,c)){
      // mover jugador
      pieces.player.delete(`${selected.r},${selected.c}`);
      pieces.player.add(`${r},${c}`);
      selected = null;
      draw();
      setTimeout(aiMoveScript, 340); // IA
    }
  }

  const isLight = (r,c) => (r+c)%2===0;
  const isEmpty = (r,c) => !pieces.player.has(`${r},${c}`) && !pieces.ai.has(`${r},${c}`);
  const isAdjacent = (r1,c1,r2,c2) => Math.abs(r1-r2)===1 && Math.abs(c1-c2)===1;

  function markTargets(){
    // Pintar posibles movimientos para la ficha seleccionada (adyacentes claros vac√≠os)
    if(!selected) return;
    for(const cell of $$(".sq")){
      const r = +cell.dataset.r, c = +cell.dataset.c;
      if(isLight(r,c) && isEmpty(r,c) && isAdjacent(selected.r,selected.c,r,c)){
        cell.classList.add("target");
      } else {
        cell.classList.remove("target");
      }
    }
  }

  function aiMoveScript(){
    // Guion muy simple para lograr los finales que pediste
    if(round===1){
      // IA captura sencilla si puede, si no avanza hacia abajo
      // Intentar capturar desde (2,3) a (4,1) si hay jugador en (3,2)
      if(pieces.ai.has("2,3") && pieces.player.has("3,2") && isEmpty(4,1)){
        pieces.ai.delete("2,3"); pieces.player.delete("3,2"); pieces.ai.add("4,1");
      } else {
        stepDownFirstAI();
      }
      draw();
      checkEndOrContinue();
    } else if(round===2){
      // Otra captura/avance
      stepDownFirstAI();
      draw();
      checkEndOrContinue();
    } else {
      // Ronda 3: dejamos ganar al jugador
      // IA hace un movimiento ‚Äúblando‚Äù
      softStepAI();
      draw();
      // Si el jugador captura cualquiera de arriba, declaramos victoria jugador:
      setTimeout(()=>{
        status.innerHTML = "¬°Tu turno! Captura una roja y gana.";
        // observador simple: si hay 3 rojas o menos => victoria jugador
        const observer = setInterval(()=>{
          if(pieces.ai.size <= 3){
            clearInterval(observer);
            endPlayerWins();
          }
        }, 250);
      }, 100);
    }
  }

  function stepDownFirstAI(){
    // Mover la primera roja hacia abajo si hay casilla clara libre
    const candidates = Array.from(pieces.ai).map(k=>k.split(",").map(Number));
    for(const [r,c] of candidates){
      const moves = [[r+1,c-1],[r+1,c+1]];
      for(const [nr,nc] of moves){
        const key = `${nr},${nc}`;
        if(nr<SIZE && nc>=0 && nc<SIZE && isLight(nr,nc) && isEmpty(nr,nc)){
          pieces.ai.delete(`${r},${c}`); pieces.ai.add(key);
          return;
        }
      }
    }
  }

  function softStepAI(){
    // mover una roja lateralmente hacia abajo si es posible, sin capturar
    stepDownFirstAI();
  }

  function checkEndOrContinue(){
    // Final r√°pido para que ‚Äúgane IA‚Äù en rondas 1 y 2
    // Si una roja llega a fila 6-7 cerca del jugador, declaramos victoria IA
    for(const key of pieces.ai){
      const r = +key.split(",")[0];
      if(r>=6){
        endAIWins();
        return;
      }
    }
    status.innerHTML = "Tu turno de nuevo. La m√°quina piensa...";
  }

  function endAIWins(){
    toast("La m√°quina gana esta partida");
    status.innerHTML = "La m√°quina te ha ganado esta ronda. Pulsa en una ficha verde para empezar otra.";
    round++;
    setTimeout(()=> initBoard(), 700);
  }

  function endPlayerWins(){
    toast("¬°Has ganado esta partida!");
    showNoraFinal();
    round = 1; // reinicia ciclo
    setTimeout(()=> initBoard(), 1800);
  }

  function showNoraFinal(){
    const msg = document.createElement("div");
    msg.className = "banner show";
    msg.innerHTML = "Nora: <em>Ya has llegado al final del crimen‚Ä¶ ¬øme seguir√°s en la pr√≥xima novela?</em>";
    document.body.appendChild(msg);
    setTimeout(()=> msg.remove(), 4200);
  }
})();

/* ====== Abrir/cerrar overlay con ESC ====== */
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape") { document.getElementById("checkersOverlay").classList.remove("show"); }
});
</script>
</body>
</html>









