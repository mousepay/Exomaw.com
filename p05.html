<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pista 5 — El mural de las agujas</title>
<style>
  :root{
    --ink:#e6f1ff;
    --muted:#aab6c8;
    --ok:#7ce0ff;
    --glow: 0 0 0 2px rgba(124,224,255,.35), 0 0 26px rgba(124,224,255,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    color: var(--ink);
    /* FONDO con imagen y capa oscura para contraste */
    background: url('fondo.png') center/cover fixed no-repeat;
    position: relative;
  }
  body::before{
    content:"";
    position: fixed; inset:0;
    /* viñeta y oscurecimiento suave para que resalten las agujas */
    background: radial-gradient(1200px 500px at 50% -10%, rgba(0,0,0,.35), rgba(0,0,0,.65) 60%, rgba(0,0,0,.8) 100%);
    pointer-events:none;
    z-index:-1;
  }
  .wrap{
    max-width: 1200px;
    margin: 24px auto 64px;
    padding: 0 16px;
  }
  h1{ margin:0 0 10px; font-weight:700; letter-spacing:.2px; }
  .lead{
    margin: 0 0 18px;
    color: var(--muted);
    line-height: 1.6;
  }
  .panel{
    background: rgba(8,12,18,.65);
    backdrop-filter: blur(2px);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 14px;
    padding: 16px;
  }
  h2{ margin:0 0 10px; font-size:20px }

  /* Grids */
  .grid{ display:grid; grid-template-columns: repeat(6,minmax(120px,1fr)); gap:14px; }
  @media (max-width:980px){ .grid{ grid-template-columns: repeat(3,minmax(100px,1fr)); } }

  /* Ranuras */
  .slot{
    position: relative;
    height: 180px;
    border-radius: 12px;
    background: rgba(12,15,20,.7);
    border: 1px dashed rgba(255,255,255,.18);
    overflow: hidden;
    cursor: pointer;
    transition: transform .15s ease, box-shadow .2s ease;
    display:flex;align-items:center;justify-content:center;
  }
  .slot:hover{ transform: translateY(-1px); }
  .slot img{
    position:absolute; inset:6px;
    width: calc(100% - 12px); height: calc(100% - 12px);
    object-fit: contain; pointer-events:none;
    filter: grayscale(1) opacity(.18);
    transition: filter .25s ease, opacity .25s ease;
  }
  .slot.placed{ border:1px solid rgba(255,255,255,.18); box-shadow: var(--glow); }
  .slot.placed img{ filter:none; opacity:1; }

  /* Biblioteca */
  .pieces{ display:grid; grid-template-columns: repeat(6,minmax(120px,1fr)); gap:14px; }
  @media (max-width:980px){ .pieces{ grid-template-columns: repeat(3,minmax(100px,1fr)); } }
  .piece{
    height:160px; border-radius:12px; background: rgba(11,15,21,.75);
    border:1px solid rgba(255,255,255,.1);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .piece:hover{ transform: translateY(-1px); }
  .piece.selected{ border-color:var(--ok); box-shadow: var(--glow); transform: translateY(-1px) scale(1.01); }
  .piece.used{ opacity:.35; pointer-events:none; filter:grayscale(1); }
  .piece img{ max-width:92%; max-height:92%; object-fit:contain; pointer-events:none; }

  /* Mensajes / botones */
  .bar{ margin-top: 14px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .msg{ flex:1 1 320px; min-height:42px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:10px 12px; line-height:1.4; }
  .btn{ appearance:none; border:0; cursor:pointer; padding:10px 14px; border-radius:10px; background:#1c2332; color:var(--ink); border:1px solid rgba(255,255,255,.12); }
  .btn:hover{ filter:brightness(1.06); }

  /* Destello especial */
  @keyframes sparkle {
    0%{ box-shadow:0 0 0 0 rgba(124,224,255,0); }
    40%{ box-shadow:0 0 0 6px rgba(124,224,255,.25), 0 0 36px rgba(124,224,255,.55); }
    70%{ box-shadow:0 0 0 2px rgba(124,224,255,.25), 0 0 18px rgba(124,224,255,.35); }
    100%{ box-shadow:var(--glow); }
  }
  .spark{ animation: sparkle .9s ease-out 1 forwards; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Pista 5 — El mural de las agujas</h1>
    <p class="lead">
      Coloca cada <strong>aguja</strong> en su <strong>ranura</strong> (verás la silueta tenue como guía).  
      <strong>Reglas:</strong> selecciona una aguja de la biblioteca y toca la ranura donde crees que encaja.
      Tienes <strong>3 intentos por aguja</strong>. Si una aguja agota sus intentos, el puzzle se
      <strong>reinicia desde el principio</strong>. Completa las 12 y la aguja especial destellará con la pista final.
    </p>

    <!-- Ranuras -->
    <section class="panel">
      <h2>Ranuras</h2>
      <div id="slots" class="grid" aria-label="Ranuras para colocar agujas"></div>
    </section>

    <!-- Biblioteca -->
    <section class="panel" style="margin-top:18px">
      <h2>Biblioteca de agujas</h2>
      <div id="pieces" class="pieces" aria-label="Agujas disponibles"></div>
      <div class="bar">
        <div id="msg" class="msg" role="status" aria-live="polite"></div>
        <button id="reset" class="btn">Reiniciar</button>
      </div>
    </section>
  </div>

<script>
(() => {
  // === Configuración ===
  const needles = [
    "aguja01","aguja02","aguja03","aguja04","aguja05","aguja06",
    "aguja07","aguja08","aguja09","aguja010","aguja011","aguja_luz"
  ];
  const MAX_TRIES = 3;  // intentos por aguja
  const encouragement = [
    "No encaja ahí. Te quedan {n} intentos para esta aguja.",
    "Buen ojo, pero no. Intentos restantes: {n}.",
    "Casi… compara la forma de la silueta. Intentos: {n}."
  ];
  const finalClue = "La hora correcta es <strong>8:30</strong> y el emblema ilumina el camino.";

  // === Estado ===
  let selected = null;           // id de aguja seleccionada
  const placed = new Set();      // agujas ya colocadas
  const triesLeft = new Map();   // id -> intentos restantes
  needles.forEach(id => triesLeft.set(id, MAX_TRIES));

  // === Utilidades ===
  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];
  const msg = (html) => $("#msg").innerHTML = html;
  const rand = (arr) => arr[Math.floor(Math.random()*arr.length)];
  const shuffle = (arr) => arr.sort(() => Math.random() - .5);

  // Construir ranuras
  function renderSlots(){
    const host = $("#slots");
    host.innerHTML = "";
    needles.forEach(id => {
      const slot = document.createElement("button");
      slot.className = "slot";
      slot.type = "button";
      slot.dataset.slot = id;
      slot.setAttribute("aria-label", `Ranura para ${id}`);
      slot.innerHTML = `<img src="${id}.png" alt="">`;
      slot.addEventListener("click", () => tryPlace(slot));
      slot.addEventListener("keydown", e => { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); tryPlace(slot);} });
      host.appendChild(slot);
    });
  }

  // Construir piezas aleatorias
  function renderPieces(){
    const host = $("#pieces");
    host.innerHTML = "";
    shuffle([...needles]).forEach(id => {
      const el = document.createElement("button");
      el.className = "piece";
      el.type = "button";
      el.dataset.id = id;
      el.setAttribute("aria-label", `Aguja ${id}`);
      el.innerHTML = `<img src="${id}.png" alt="Aguja ${id}">`;
      el.addEventListener("click", () => selectPiece(el));
      el.addEventListener("keydown", e => { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); selectPiece(el);} });
      host.appendChild(el);
    });
  }

  function clearSelection(){
    $$(".piece.selected").forEach(p => p.classList.remove("selected"));
    selected = null;
  }

  function selectPiece(el){
    if(el.classList.contains("used")) return;
    if(selected === el.dataset.id){
      el.classList.remove("selected");
      selected = null;
      msg("Has deseleccionado la aguja.");
      return;
    }
    clearSelection();
    selected = el.dataset.id;
    el.classList.add("selected");
    msg(`Aguja seleccionada: <strong>${selected}</strong>. Toca la ranura correspondiente. Intentos disponibles: <strong>${triesLeft.get(selected)}</strong>.`);
  }

  function tryPlace(slot){
    if(!selected){ msg("Selecciona primero una aguja en la biblioteca."); return; }

    const expect = slot.dataset.slot;
    if(selected === expect){
      // Correcta
      placed.add(selected);
      const img = slot.querySelector("img");
      if(img){ img.style.filter = "none"; img.style.opacity = "1"; }
      slot.classList.add("placed","spark");
      setTimeout(()=>slot.classList.remove("spark"), 900);
      const btn = $(`.piece[data-id="${selected}"]`);
      if(btn){ btn.classList.add("used"); btn.classList.remove("selected"); }
      msg(`¡Encaja! <strong>${selected}</strong> colocada. `+
          `Quedan <strong>${needles.length - placed.size}</strong>.`);
      selected = null;

      if(placed.size === needles.length){
        const special = $(`.slot[data-slot="aguja_luz"]`);
        if(special){ special.classList.add("spark"); setTimeout(()=>special.classList.remove("spark"), 1200); }
        setTimeout(()=> msg(`✨ <strong>Pista final:</strong> ${finalClue}`), 350);
      }
      return;
    }

    // Incorrecta → restar intento
    const left = Math.max(0, (triesLeft.get(selected) ?? MAX_TRIES) - 1);
    triesLeft.set(selected, left);
    if(left === 0){
      // Reinicio completo
      msg(`Has agotado los intentos de <strong>${selected}</strong>. El puzzle se reinicia…`);
      setTimeout(resetAll, 900);
    }else{
      const txt = rand(encouragement).replace("{n}", `<strong>${left}</strong>`);
      msg(txt);
    }
  }

  function resetAll(){
    placed.clear();
    clearSelection();
    triesLeft.clear();
    needles.forEach(id => triesLeft.set(id, MAX_TRIES));
    renderSlots();
    renderPieces();
    msg("Puzzle reiniciado. Selecciona una aguja y colócala en su ranura. Recuerda: 3 intentos por aguja.");
  }

  // Inicio
  renderSlots();
  renderPieces();
  msg("Selecciona una aguja y colócala en su ranura. Tienes <strong>3 intentos por aguja</strong>. ¡Suerte!");

  $("#reset").addEventListener("click", resetAll);
})();
</script>
</body>
</html>



