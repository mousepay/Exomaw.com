<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pista 5 ‚Äî Enigma de las agujas + Damas</title>
<style>
  :root{
    --text: #0f1b17;
    --card: rgba(255,255,255,.78);
    --soft: rgba(255,255,255,.55);
    --accent: #0e7b6c;
    --ok: #0b8d42;
    --bad: #c4382e;
    --warn: #f0b429;

    --green-dark: #0e3a28;
    --green-light: #eaf7f1;
  }

  /* ====== FONDO (BUTACAS) SIN OSCURECER ====== */
  html,body{ height:100%; margin:0; font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
  body{
    color: var(--text);
    background: url("fondo.png") center/cover no-repeat fixed #0b1a15;
  }
  /* velo MUY suave para contraste del texto */
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none;
    background: linear-gradient(to bottom, rgba(255,255,255,.08), rgba(255,255,255,.18) 35%, rgba(255,255,255,.08));
    mix-blend-mode: lighten;
  }

  .wrap{ max-width: 1200px; margin: 18px auto 100px; padding: 0 16px; }
  .header{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  h1{ margin:0; font-size: clamp(26px, 4vw, 46px); color:#ffffff; text-shadow:0 2px 18px rgba(0,0,0,.35); }
  .pill{
    background: rgba(255,255,255,.35);
    padding: 8px 12px; border-radius:999px; backdrop-filter: blur(3px);
    color:#073229; border:1px solid rgba(255,255,255,.6);
    font-weight:600;
  }
  .btn{
    appearance:none; border:0; cursor:pointer;
    background:#0ea5a3; color:#052a27; font-weight:700;
    padding:10px 14px; border-radius:12px;
    transition: transform .06s ease, box-shadow .2s ease, background .15s ease;
    box-shadow: 0 6px 24px rgba(14,165,163,.25);
  }
  .btn.secondary{ background:#e8f4f2; color:#08534a; box-shadow:none; }
  .btn:active{ transform: translateY(1px); }

  .card{
    background: var(--card);
    border:1px solid rgba(0,0,0,.08);
    border-radius:18px;
    padding:18px;
    box-shadow: 0 10px 30px rgba(0,0,0,.18);
    margin-top:16px;
  }

  /* ====== ENIGMA DE LAS AGUJAS ====== */
  .areas{ display:grid; gap:18px; grid-template-columns: 1fr 1fr; }
  @media(max-width: 980px){ .areas{ grid-template-columns: 1fr; } }

  .panel-title{ font-size:22px; margin:2px 0 12px; color:#083d34; }
  .slots, .library{
    background: rgba(255,255,255,.6);
    border:1px dashed rgba(0,0,0,.15);
    border-radius:16px; padding:16px;
    min-height: 260px;
    display:grid; grid-template-columns: repeat(3,minmax(110px,1fr));
    gap:14px;
  }
  .slot, .needle{
    position:relative;
    display:flex; align-items:center; justify-content:center;
    border-radius:14px; overflow:hidden;
    background: rgba(255,255,255,.75);
    border:1px solid rgba(0,0,0,.08);
    min-height: 140px;
  }
  /* SOMBRA CLARA Y VISIBLE */
  .slot::before{
    content:"";
    position:absolute; inset:8px;
    background:
      radial-gradient(ellipse 60% 30% at 50% 8%, rgba(0,0,0,.06), rgba(0,0,0,0) 70%),
      radial-gradient(circle at 50% 35%, rgba(0,0,0,.10), rgba(0,0,0,0) 62%);
    opacity:.9;           /* << bien visible */
    filter: blur(0.6px);
    pointer-events:none;
  }
  .slot.is-target{ outline: 2px solid var(--warn); box-shadow: 0 0 0 6px rgba(240,180,41,.15) inset; }
  .slot.correct{ outline: 2px solid var(--ok); box-shadow: 0 0 0 6px rgba(11,141,66,.18) inset; }
  .slot.fail{ outline: 2px solid var(--bad); box-shadow: 0 0 0 6px rgba(196,56,46,.18) inset; }

  .needle{ background: rgba(255,255,255,.9); cursor:grab; transition: transform .08s ease, box-shadow .2s ease; }
  .needle:active{ cursor:grabbing; transform: scale(.98); }
  .needle img{ max-width: 80px; max-height: 100px; object-fit: contain; filter: drop-shadow(0 4px 10px rgba(0,0,0,.35)); }
  .hint{ color:#0c5247; margin: 8px 0 0; font-size: 14px; opacity:.9; }

  .flash{ position: fixed; inset:0; pointer-events:none; background: radial-gradient(circle at 50% 45%, rgba(255,255,255,.92), rgba(255,255,255,0) 55%); opacity:0; transition: opacity .35s ease; }
  .flash.on{ opacity:1; animation: fadeFlash .9s ease forwards; }
  @keyframes fadeFlash{ 0%{opacity:1} 60%{opacity:.45} 100%{opacity:0} }

  .final-msg{ display:none; margin-top:12px; padding:14px; background:#f2fbf8; border:1px solid rgba(0,0,0,.1); border-radius:12px; color:#0a3a32; }

  /* ====== TABLERO DE DAMAS ====== */
  .overlay{ position:fixed; inset:0; display:none; place-items:center; background: rgba(0,0,0,.55); z-index:50; }
  .overlay.show{ display:grid; }
  .modal{ width:min(980px, 94vw); background: #ffffff; color:#0b2a24; border-radius:16px; padding:16px 18px 18px; box-shadow: 0 30px 80px rgba(0,0,0,.35); border:1px solid rgba(0,0,0,.08); }
  .board-wrap{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  @media(max-width: 980px){ .board-wrap{ grid-template-columns: 1fr; } }

  .board{ width:100%; aspect-ratio: 1/1; max-width: 620px; margin:auto; border-radius:16px; overflow:hidden; border:1px solid rgba(0,0,0,.1); box-shadow: 0 12px 28px rgba(0,0,0,.25); }
  .grid{ display:grid; grid-template-columns: repeat(8,1fr); width:100%; height:100%; }
  .sq{ display:flex; align-items:center; justify-content:center; user-select:none; }
  .sq.dark{ background:#0c3a28; }   /* verde oscuro */
  .sq.light{ background:#e2f6ea; }  /* verde claro */

  .piece{ width:min(66px, 9.4vmin); height:min(66px, 9.4vmin); border-radius:50%; display:grid; place-items:center; cursor:pointer; user-select:none; border:3px solid rgba(0,0,0,.35); box-shadow: 0 8px 20px rgba(0,0,0,.28); background-size: 70% auto; background-position:center; background-repeat:no-repeat; }
  .piece.player{ background-color: #1e7f58; } /* VERDE */
  .piece.ai{ background-color: #b84239; }     /* ROJO */

  .sq.target{ outline: 3px solid var(--warn); box-shadow: inset 0 0 0 6px rgba(240,180,41,.25); }
  .status{ font-size:15px; color:#0e3b33; background:#f3fbf8; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px; margin-top:10px; }

  /* Avisos / frases */
  .banner{ position:fixed; left:50%; bottom:24px; transform: translateX(-50%); background: rgba(255,255,255,.92); border:1px solid rgba(0,0,0,.12); color:#083831; padding:12px 16px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); display:none; z-index:60; }
  .banner.show{ display:block; }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>PISTA 5 ‚Äî El enigma de las agujas</h1>
    <span class="pill">Arrastra una aguja a su ranura. Solo 3 fallos en total.</span>
    <button id="openCheckers" class="btn">Jugar al tablero de damas</button>
  </div>

  <div class="card">
    <p>Empieza cuando quieras. Selecciona una aguja y luego una ranura. Cuando coloques la <em>aguja de luz</em> ver√°s un destello y aparecer√° la pista final.</p>

    <div class="areas">
      <section>
        <div class="panel-title">Ranuras (sombras)</div>
        <div id="slots" class="slots" aria-label="ranuras"></div>
        <p class="hint">Ahora la sombra es clara para que se vea bien la forma üòä</p>
      </section>

      <section>
        <div class="panel-title">Biblioteca de agujas</div>
        <div id="library" class="library" aria-label="biblioteca"></div>
        <p class="hint">Hay una ‚Äúaguja de luz‚Äù. Si aciertas su ranura, aparece el destello y una pista.</p>
      </section>
    </div>

    <div id="finalClue" class="final-msg"></div>
  </div>
</div>

<!-- DAMAS -->
<div id="checkersOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Tablero de damas">
  <div class="modal">
    <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
      <h2 style="margin:0;color:#083831">Tablero de damas</h2>
      <button id="closeCheckers" class="btn secondary">Cerrar</button>
    </div>

    <div class="board-wrap" style="margin-top:10px">
      <div>
        <div id="board" class="board"><div id="grid" class="grid"></div></div>
        <div id="status" class="status">Mueve una ficha <strong>verde</strong> con silueta (Daniel, Nora, Arturo, Tom√°s). Ronda 1 y 2: pierde el lector (sale frase de √°nimo). Ronda 3: ¬°te dejan ganar! y sale la frase de Nora.</div>
      </div>
      <div class="card" style="margin:0">
        <h3 style="margin:6px 0 8px;color:#0c463d">Instrucciones (demo)</h3>
        <ol style="margin:0 0 8px 18px">
          <li>Click en tu ficha verde y luego en una casilla clara adyacente.</li>
          <li>La m√°quina (rojas) mover√° autom√°ticamente.</li>
          <li>Tras perder dos veces, a la tercera te deja ganar y ver√°s el mensaje de Nora.</li>
        </ol>
        <button id="resetDemo" class="btn">Reiniciar demo</button>
      </div>
    </div>
  </div>
</div>

<!-- avisos -->
<div id="toast" class="banner"></div>
<div class="flash" id="flash"></div>

<script>
/* ====== helpers ====== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function say(msg, ms=1800){
  const b = $("#toast"); b.textContent = msg; b.classList.add("show");
  setTimeout(()=> b.classList.remove("show"), ms);
}

/* =========================================================
   ENIGMA DE LAS AGUJAS ‚Äî 3 fallos globales + frases de √°nimo
========================================================= */
(function(){
  // Cambia, a√±ade o quita agujas seg√∫n tus archivos.
  const NEEDLES = [
    { id:"aguja01", img:"aguja01.png", name:"Aguja fina" },
    { id:"aguja02", img:"aguja02.png", name:"Aguja curva" },
    { id:"aguja03", img:"aguja03.png", name:"Aguja de luz" } // especial
  ];
  const LIGHT_ID = "aguja03";

  const PHRASES_HIT = [
    "¬°Bien! Precisi√≥n de cirujano.",
    "¬°Eso encaja perfecto!",
    "¬°Otro paso hacia la verdad!"
  ];
  const PHRASES_MISS = [
    "Tranquilo, prueba otra combinaci√≥n.",
    "No pasa nada, respira y mira la silueta.",
    "Casi‚Ä¶ conc√©ntrate en la forma."
  ];
  const PHRASES_RESET = [
    "Se desmont√≥ el juego‚Ä¶ pero tu mente sigue afilada. ¬°Int√©ntalo de nuevo!",
    "Tres fallos y el reloj se resetea. Vuelve a empezar: lo har√°s mejor.",
    "Reinicio. La paciencia tambi√©n es una pista."
  ];

  const PHRASE_ALL_DONE = "Las agujas han hablado: siempre apuntan a nuestro centro. Sigue tu rumbo.";

  const slotsEl = $("#slots");
  const libEl = $("#library");
  const finalBox = $("#finalClue");
  const flash = $("#flash");

  let globalFails = 0;
  let solvedCount = 0;

  function build(){
    slotsEl.innerHTML = "";
    libEl.innerHTML = "";
    finalBox.style.display = "none";
    finalBox.innerHTML = "";
    globalFails = 0;
    solvedCount = 0;

    // Slots emparejados 1:1 por id
    NEEDLES.forEach(n=>{
      const s = document.createElement("div");
      s.className = "slot"; s.dataset.accept = n.id;
      s.addEventListener("dragover", e=>{ e.preventDefault(); s.classList.add("is-target"); });
      s.addEventListener("dragleave", ()=> s.classList.remove("is-target"));
      s.addEventListener("drop", e=>{
        e.preventDefault(); s.classList.remove("is-target");
        handleDrop(s, e.dataTransfer.getData("text/needle"));
      });
      slotsEl.appendChild(s);
    });

    NEEDLES.forEach(n=>{
      const d = document.createElement("div");
      d.className = "needle"; d.draggable = true; d.dataset.id = n.id; d.title = n.name;
      d.addEventListener("dragstart", e=> e.dataTransfer.setData("text/needle", n.id));
      const img = document.createElement("img"); img.src = n.img; img.alt = n.name;
      d.appendChild(img); libEl.appendChild(d);
    });
  }

  function handleDrop(slot, draggedId){
    const accept = slot.dataset.accept;
    if(slot.classList.contains("correct")) { say("Esa ranura ya est√° resuelta"); return; }

    if(draggedId === accept){
      slot.classList.add("correct");
      solvedCount++;
      say(PHRASES_HIT[Math.floor(Math.random()*PHRASES_HIT.length)]);

      // Colocar visualmente la aguja dentro
      const img = document.createElement("img");
      const n = NEEDLES.find(x=>x.id===draggedId);
      img.src = n?.img || ""; img.style.maxWidth="80px"; img.style.maxHeight="100px";
      slot.innerHTML = ""; slot.appendChild(img);

      if(draggedId === LIGHT_ID){
        flash.classList.add("on");
        setTimeout(()=> flash.classList.remove("on"), 900);
        finalBox.style.display = "block";
        finalBox.innerHTML = `<strong>Pista:</strong> ‚ÄúDonde la luz cae, el secreto se revela.‚Äù`;
      }
      if(solvedCount === NEEDLES.length){
        setTimeout(()=>{
          finalBox.style.display = "block";
          finalBox.innerHTML = `<strong>¬°Perfecto!</strong> ${PHRASE_ALL_DONE}`;
        }, 250);
      }
    } else {
      slot.classList.add("fail"); setTimeout(()=> slot.classList.remove("fail"), 700);
      globalFails++;
      if(globalFails >= 3){
        say(PHRASES_RESET[Math.floor(Math.random()*PHRASES_RESET.length)], 2400);
        setTimeout(build, 900);
      } else {
        say(PHRASES_MISS[Math.floor(Math.random()*PHRASES_MISS.length)]);
      }
    }
  }

  build();
})();

/* =========================================================
   TABLERO DE DAMAS ‚Äî Siluetas + pierde 2, gana 1 + frases
========================================================= */
(function(){
  const overlay = $("#checkersOverlay");
  const openBtn = $("#openCheckers");
  const closeBtn = $("#closeCheckers");
  const resetBtn = $("#resetDemo");
  const grid = $("#grid");
  const status = $("#status");

  // Mapea aqu√≠ los PNG de SILUETAS en negro para las fichas verdes
  const PLAYER_SPRITES = {
    "Daniel": "silueta-daniel.png",
    "Nora":   "silueta-nora.png",
    "Arturo": "silueta-arturo.png",
    "Tom√°s":  "silueta-tomas.png"
  };

  const LOSE_PHRASES = [
    "¬°√Ånimo! Cada jugada te ense√±a algo.",
    "Vas bien, observa dos movimientos por delante.",
    "No te rindas, el final est√° cerca."
  ];

  let round = 1;           // 1 y 2: pierde jugador; 3: gana jugador
  let selected = null;     // {r,c}
  let pieces = null;       // { player:Set, ai:Set }

  openBtn.addEventListener("click", ()=>{ overlay.classList.add("show"); initBoard(true); });
  closeBtn.addEventListener("click", ()=> overlay.classList.remove("show"));
  resetBtn.addEventListener("click", ()=> { round=1; initBoard(true); });

  function initBoard(resetText=false){
    grid.innerHTML = "";
    selected = null;
    pieces = {
      player: new Set(["6,1","6,3","6,5","6,7"]),
      ai:     new Set(["1,2","1,4","1,6","2,3","2,5"])
    };
    if(resetText){
      status.innerHTML = "Empieza la demo. La m√°quina te ganar√° dos veces; a la tercera, te dejar√° ganar. ¬°Vamos!";
    }
    draw();
  }

  const SIZE=8;
  const isLight = (r,c) => (r+c)%2===0;
  const isEmpty = (r,c) => !pieces.player.has(`${r},${c}`) && !pieces.ai.has(`${r},${c}`);
  const isAdjacent = (r1,c1,r2,c2) => Math.abs(r1-r2)===1 && Math.abs(c1-c2)===1;

  function draw(){
    grid.innerHTML = "";
    for(let r=0;r<SIZE;r++){
      for(let c=0;c<SIZE;c++){
        const cell = document.createElement("div");
        cell.className = "sq " + ((r+c)%2 ? "dark":"light");
        cell.dataset.r = r; cell.dataset.c = c;

        const key = `${r},${c}`;
        if(pieces.player.has(key)){
          const piece = document.createElement("div");
          piece.className = "piece player";
          // asignar siluetas a las 4 fichas
          const name = nameFor(key);
          piece.title = name;
          const sprite = PLAYER_SPRITES[name];
          if(sprite){ piece.style.backgroundImage = `url("${sprite}")`; }
          cell.appendChild(piece);
        } else if(pieces.ai.has(key)){
          const piece = document.createElement("div");
          piece.className = "piece ai";
          piece.style.backgroundImage = "url('')";
          cell.appendChild(piece);
        }

        cell.addEventListener("click", ()=> onSquareClick(r,c));
        grid.appendChild(cell);
      }
    }
    markTargets();
  }

  function nameFor(key){
    const order = ["6,1","6,3","6,5","6,7"];
    const names = ["Daniel","Nora","Arturo","Tom√°s"];
    const i = order.indexOf(key);
    return names[i] || "Jugador";
  }

  function onSquareClick(r,c){
    const key = `${r},${c}`;
    if(pieces.player.has(key)){
      selected = {r,c};
      draw();
      return;
    }
    if(selected && isLight(r,c) && isEmpty(r,c) && isAdjacent(selected.r,selected.c,r,c)){
      pieces.player.delete(`${selected.r},${selected.c}`);
      pieces.player.add(`${r},${c}`);
      selected = null;
      draw();
      setTimeout(aiMoveScript, 320);
    }
  }

  function markTargets(){
    if(!selected) return;
    for(const cell of $$(".sq")){
      const r = +cell.dataset.r, c = +cell.dataset.c;
      if(isLight(r,c) && isEmpty(r,c) && isAdjacent(selected.r,selected.c,r,c)){
        cell.classList.add("target");
      } else cell.classList.remove("target");
    }
  }

  function aiMoveScript(){
    if(round===1 || round===2){
      stepDownFirstAI(); draw();
      // declarar derrota r√°pida para mostrar frase
      say(LOSE_PHRASES[Math.floor(Math.random()*LOSE_PHRASES.length)], 1800);
      setTimeout(()=> endAIWins(), 700);
    } else {
      // ronda 3: IA se mueve suave y te deja ganar
      stepDownFirstAI(); draw();
      status.innerHTML = "Tu turno. Puedes forzar la victoria.";
      const watcher = setInterval(()=>{
        // cuando el jugador llegue a fila 1-2 o queden <=3 rojas, declaramos victoria jugador
        for(const k of pieces.player){
          const r = +k.split(",")[0];
          if(r<=2 || pieces.ai.size<=3){ clearInterval(watcher); endPlayerWins(); break; }
        }
      }, 250);
    }
  }
  function stepDownFirstAI(){
    const cand = Array.from(pieces.ai).map(k=>k.split(",").map(Number));
    for(const [r,c] of cand){
      for(const [nr,nc] of [[r+1,c-1],[r+1,c+1]]){
        if(nr<SIZE && nc>=0 && nc<SIZE && isLight(nr,nc) && isEmpty(nr,nc)){
          pieces.ai.delete(`${r},${c}`); pieces.ai.add(`${nr},${nc}`); return;
        }
      }
    }
  }
  function endAIWins(){
    status.innerHTML = "La m√°quina te ha ganado esta ronda. Respira, observa y vuelve a intentarlo.";
    round++; setTimeout(()=> initBoard(), 800);
  }
  function endPlayerWins(){
    const msg = document.createElement("div");
    msg.className = "banner show";
    msg.innerHTML = "Nora: <em>Al final de la l√≠nea del reloj has llegado a la novela‚Ä¶ ¬øme seguir√°s en mi pr√≥xima aventura?</em>";
    document.body.appendChild(msg);
    setTimeout(()=> msg.remove(), 5200);
    round = 1; setTimeout(()=> initBoard(), 1600);
  }

  // abrir/cerrar
  document.addEventListener("keydown", e=>{
    if(e.key==="Escape") overlay.classList.remove("show");
  });
})();

/* abrir overlay */
$("#openCheckers").addEventListener("click", ()=> $("#checkersOverlay").classList.add("show"));
$("#closeCheckers").addEventListener("click", ()=> $("#checkersOverlay").classList.remove("show"));
</script>
</body>
</html>









