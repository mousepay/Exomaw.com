<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pista 5 — El mural y las agujas</title>

<style>
  :root{
    --bg:#0b0b0b; --ink:#eee; --muted:#bdbdbd; --accent:#8be6ff; --accent2:#4cff9e;
    --panel:rgba(0,0,0,.6);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5}

  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .title{margin:0 0 8px;font-size:clamp(20px,1.2rem + .8vw,28px)}
  .muted{color:var(--muted)}
  .panel{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:14px}

  /* ===== Escena del salón ===== */
  .scene{
    position:relative; aspect-ratio: 16/9; width:100%;
    background:#0a0a0a url('fondo.png') center/cover no-repeat;
    border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,.15);
  }
  /* zonas de asiento (drop) */
  .seat{
    position:absolute; width:26%; aspect-ratio:1/1;
    border:2px dashed rgba(255,255,255,.35); border-radius:14px;
    backdrop-filter: blur(0.5px);
  }
  .seat.dragover{outline:3px solid var(--accent); outline-offset:3px}
  /* posiciones aproximadas sobre las butacas */
  .seat.left{ left:18%; top:37%;}
  .seat.right{ left:57%; top:37%;}

  /* otras zonas (taza/mancha) — opcional, las mantenemos */
  .spot{
    position:absolute; width:17%; aspect-ratio:1/1;
    border:2px dashed rgba(255,255,255,.25); border-radius:12px;
  }
  .spot.taza{ right:15%; bottom:9%;}
  .spot.mancha{ right:33%; bottom:9%;}

  /* pieza arrastrable (siluetas/tazas/mancha) */
  .piece{
    position:absolute; left:0; top:0; transform-origin:center center;
    touch-action:none; cursor:grab; user-select:none;
    transition: box-shadow .2s ease;
  }
  .piece:active{ cursor:grabbing; }
  .piece.selected{ box-shadow: 0 0 0 3px var(--accent) inset; border-radius:10px }

  /* bandeja de piezas */
  .tray{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px }
  .tray .thumb{
    width:110px; height:82px; border-radius:10px; overflow:hidden; background:#111;
    border:1px solid rgba(255,255,255,.2); cursor:grab; display:grid; place-items:center;
  }
  .tray img{ max-width:100%; max-height:100%; pointer-events:none }

  /* controles de escala */
  .scale-controls{
    position:sticky; bottom:10px; display:flex; gap:8px; justify-content:flex-start; margin-top:10px;
  }
  .btn{
    appearance:none; border:1px solid #fff; background:#fff; color:#000; font-weight:800;
    padding:8px 12px; border-radius:999px; cursor:pointer;
  }
  .btn.ghost{ background:transparent; color:#fff; }
  .btn:active{ transform:translateY(1px) }

  /* ===== Agujas ===== */
  .needles{ margin-top:22px }
  .grid{
    display:grid; gap:14px;
    grid-template-columns: repeat(6, minmax(120px,1fr));
  }
  @media (max-width:900px){ .grid{ grid-template-columns: repeat(3, 1fr) } }
  @media (max-width:520px){ .grid{ grid-template-columns: repeat(2, 1fr) } }

  .needle{
    background:#0f0f10; border:1px solid rgba(255,255,255,.12);
    border-radius:14px; padding:10px; display:grid; place-items:center;
    filter: brightness(.85) saturate(.9);
  }
  .needle img{ width:100%; height:auto; pointer-events:none; user-select:none }
  .needle.dragstart{ outline:2px solid var(--accent); }

  .try-row{
    display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; margin-top:14px;
  }
  @media (max-width:780px){ .try-row{ grid-template-columns:1fr } }

  .slot{
    min-height:200px; display:grid; place-items:center;
    border:2px dashed rgba(255,255,255,.35); border-radius:14px;
    background:rgba(255,255,255,.02);
    position:relative; overflow:hidden;
  }
  .slot.dragover{ outline:3px solid var(--accent2); outline-offset:2px }
  .slot .placed{ max-width:90%; height:auto; display:block }

  .flash{ animation:flash 750ms ease-out 1 }
  @keyframes flash{
    0%{ box-shadow:0 0 0 rgba(255,255,255,0) }
    40%{ box-shadow:0 0 55px rgba(120,255,200,.9) }
    100%{ box-shadow:0 0 0 rgba(255,255,255,0) }
  }

  .tip{ margin-top:10px; font-style:italic; color:#e8f7ff; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15); padding:10px 12px; border-radius:12px }

  /* helpers */
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .space{ height:14px }
</style>
</head>
<body>

<div class="wrap">
  <h1 class="title">Pista 5 — El mural y las agujas</h1>
  <p class="muted">Arrastra <strong>las siluetas</strong> y si hace falta usa <em>+</em> y <em>–</em> para ajustarlas y que queden sentadas en las butacas. Después, prueba <strong>las agujas</strong> en la ranura: si no encaja, leerás un mensaje; si aciertas, verás un destello y aparecerá la pista.</p>

  <!-- ===== ESCENA / SALÓN ===== -->
  <section class="scene" id="scene">
    <!-- Zonas de asiento -->
    <div class="seat left"  data-accept="silueta"></div>
    <div class="seat right" data-accept="silueta"></div>
    <!-- Zonas extra (opcional) -->
    <div class="spot mancha" data-accept="mancha"></div>
    <div class="spot taza"   data-accept="taza"></div>
    <!-- Piezas (se colocan inicialmente sueltas, abajo hay miniaturas para reponer) -->
  </section>

  <!-- Bandeja / biblioteca de piezas -->
  <div class="panel" style="margin-top:10px">
    <strong>Biblioteca de piezas</strong>
    <div class="tray" id="tray">
      <div class="thumb" data-type="silueta" data-src="silueta_a.png"><img src="silueta_a.png" alt=""></div>
      <div class="thumb" data-type="silueta" data-src="silueta_b.png"><img src="silueta_b.png" alt=""></div>
      <div class="thumb" data-type="taza" data-src="taza_a.png"><img src="taza_a.png" alt=""></div>
      <div class="thumb" data-type="taza" data-src="taza_b.png"><img src="taza_b.png" alt=""></div>
      <div class="thumb" data-type="mancha" data-src="mancha.png"><img src="mancha.png" alt=""></div>
    </div>

    <div class="scale-controls">
      <button class="btn ghost" id="smaller">–</button>
      <button class="btn" id="bigger">+</button>
      <span class="muted" id="scaleHint">(Selecciona una pieza para cambiar su tamaño)</span>
    </div>
  </div>

  <div class="space"></div>

  <!-- ===== AGUJAS ===== -->
  <section class="needles">
    <h2 class="title" style="font-size:1.2rem">Prueba las agujas</h2>
    <div class="grid" id="needleGrid">
      <!-- 12 agujas (11 normales + 1 aguja_luz) -->
      <div class="needle" draggable="true"><img src="aguja01.png" alt="aguja 1"></div>
      <div class="needle" draggable="true"><img src="aguja02.png" alt="aguja 2"></div>
      <div class="needle" draggable="true"><img src="aguja03.png" alt="aguja 3"></div>
      <div class="needle" draggable="true"><img src="aguja04.png" alt="aguja 4"></div>
      <div class="needle" draggable="true"><img src="aguja05.png" alt="aguja 5"></div>
      <div class="needle" draggable="true"><img src="aguja06.png" alt="aguja 6"></div>
      <div class="needle" draggable="true"><img src="aguja07.png" alt="aguja 7"></div>
      <div class="needle" draggable="true"><img src="aguja08.png" alt="aguja 8"></div>
      <div class="needle" draggable="true"><img src="aguja09.png" alt="aguja 9"></div>
      <div class="needle" draggable="true"><img src="aguja010.png" alt="aguja 10"></div>
      <div class="needle" draggable="true"><img src="aguja011.png" alt="aguja 11"></div>
      <div class="needle" draggable="true"><img src="aguja_luz.png" alt="aguja correcta"></div>
    </div>

    <div class="try-row">
      <div class="slot" id="slot">
        <span class="muted">Suelta aquí una aguja para probarla</span>
      </div>
      <div class="panel">
        <strong>Mensajes</strong>
        <div class="tip" id="msg">Elige una aguja y pruébala…</div>
      </div>
    </div>
  </section>

  <div class="space"></div>
  <div class="row">
    <button class="btn ghost" onclick="location.href='index.html'">← Volver a pistas</button>
  </div>
  <div class="space"></div>
</div>

<script>
/* ===========================================================
   Utilidades de drag en móvil y desktop
   =========================================================== */
function enableDragFor(el, kind){
  // Desktop drag (para la ranura de agujas usamos DataTransfer; para siluetas usamos pointer).
  if(kind === 'needle'){
    el.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/plain', el.querySelector('img').getAttribute('src'));
      el.classList.add('dragstart');
    });
    el.addEventListener('dragend', ()=> el.classList.remove('dragstart'));
  }
}

/* ===========================================================
   1) Salón: piezas posicionables + escala
   =========================================================== */
const scene = document.getElementById('scene');
const tray  = document.getElementById('tray');

let zTop = 10;
let selectedPiece = null;

function addPiece(src, type, x=10, y=70, scale=1){
  const img = new Image();
  img.src = src;
  img.onload = ()=>{
    const piece = document.createElement('img');
    piece.src = src;
    piece.className = 'piece';
    piece.dataset.type = type;
    piece.style.left = x+'%';
    piece.style.top  = y+'%';
    piece.style.width = Math.min(30, (img.width>img.height? 22 : 18)) + '%'; // tamaño base adaptable
    piece.style.transform = `translate(-50%,-50%) scale(${scale})`;
    piece.style.zIndex = String(++zTop);
    piece.draggable = false;
    scene.appendChild(piece);

    // Selección
    piece.addEventListener('pointerdown', (e)=>{
      selectedPiece?.classList.remove('selected');
      selectedPiece = piece;
      piece.classList.add('selected');
      piece.setPointerCapture(e.pointerId);
      piece._drag = {dx:0, dy:0};
    });
    piece.addEventListener('pointermove', (e)=>{
      if(!piece.hasPointerCapture(e.pointerId)) return;
      const rect = scene.getBoundingClientRect();
      const nx = ((e.clientX - rect.left)/rect.width)*100;
      const ny = ((e.clientY - rect.top)/rect.height)*100;
      piece.style.left = Math.max(0, Math.min(100, nx))+'%';
      piece.style.top  = Math.max(0, Math.min(100, ny))+'%';
    });
    piece.addEventListener('pointerup', (e)=>{
      tryDropOnTargets(piece);
      piece.releasePointerCapture(e.pointerId);
    });
  };
}

function tryDropOnTargets(piece){
  const type = piece.dataset.type;
  const targets = [...scene.querySelectorAll('.seat, .spot')];
  const pr = piece.getBoundingClientRect();
  for(const t of targets){
    const accept = t.dataset.accept;
    const tr = t.getBoundingClientRect();
    const overlap = !(pr.right<tr.left || pr.left>tr.right || pr.bottom<tr.top || pr.top>tr.bottom);
    if(overlap && ((accept==='silueta' && type==='silueta') || (accept===type))){
      // centra la pieza dentro del target
      const sc  = scene.getBoundingClientRect();
      const cx = ((tr.left + tr.width/2) - sc.left)/sc.width*100;
      const cy = ((tr.top  + tr.height/2) - sc.top )/sc.height*100;
      piece.style.left = cx+'%';
      piece.style.top  = cy+'%';
      // lleva la pieza por encima
      piece.style.zIndex = String(++zTop);
      // resalta destino
      t.classList.add('flash');
      setTimeout(()=> t.classList.remove('flash'), 600);
      return;
    }
  }
}

// miniaturas → crear piezas
tray.addEventListener('click', (e)=>{
  const th = e.target.closest('.thumb'); if(!th) return;
  addPiece(th.dataset.src, th.dataset.type);
});

// controles de escala
document.getElementById('bigger').addEventListener('click', ()=>{
  if(!selectedPiece) return;
  // limita a 1.6x
  const m = selectedPiece.style.transform.match(/scale\(([^)]+)\)/);
  const s = m? parseFloat(m[1]) : 1;
  const ns = Math.min(1.6, s + 0.08);
  selectedPiece.style.transform = `translate(-50%,-50%) scale(${ns})`;
});
document.getElementById('smaller').addEventListener('click', ()=>{
  if(!selectedPiece) return;
  const m = selectedPiece.style.transform.match(/scale\(([^)]+)\)/);
  const s = m? parseFloat(m[1]) : 1;
  const ns = Math.max(0.7, s - 0.08);
  selectedPiece.style.transform = `translate(-50%,-50%) scale(${ns})`;
});

// estados visuales al pasar por encima
scene.querySelectorAll('.seat, .spot').forEach(t=>{
  t.addEventListener('dragover', e=> e.preventDefault());
  t.addEventListener('dragenter', ()=> t.classList.add('dragover'));
  t.addEventListener('dragleave', ()=> t.classList.remove('dragover'));
});

/* ===========================================================
   2) Agujas: probar en ranura con frases y acierto
   =========================================================== */
const messages = {
  'aguja01.png':  'No encaja… vuelve a intentarlo; el tiempo no juega a tu favor.',
  'aguja02.png':  'Demasiado fina. El murmullo del reloj te dice que no es por aquí.',
  'aguja03.png':  'Esta forma engaña. Quizá otra geometría.',
  'aguja04.png':  'No. El marco la rechaza suavemente.',
  'aguja05.png':  'Tic… tac… sigue probando.',
  'aguja06.png':  'El diente no coincide. Prueba otra.',
  'aguja07.png':  'Demasiado corta. El ritmo se pierde.',
  'aguja08.png':  'Casi… pero no. Falta una pista.',
  'aguja09.png':  'El metal parece correcto, la forma no.',
  'aguja010.png': 'No abre el paso del tiempo.',
  'aguja011.png': 'Sientes que estás cerca, pero no es esta.',
  'aguja_luz.png': '“Soy Nora y estoy segura de que la pista es la misma que la mía”.'
};
const slot = document.getElementById('slot');
const msg  = document.getElementById('msg');
let slotLocked = false;

// habilita drag para todas las agujas
document.querySelectorAll('.needle').forEach(n=> enableDragFor(n,'needle'));

// eventos del slot (desktop)
slot.addEventListener('dragover', e=>{ e.preventDefault(); if(!slotLocked) slot.classList.add('dragover'); });
slot.addEventListener('dragleave', ()=> slot.classList.remove('dragover'));
slot.addEventListener('drop', e=>{
  e.preventDefault();
  slot.classList.remove('dragover');
  if(slotLocked) return;

  const src = e.dataTransfer.getData('text/plain');
  testNeedle(src);
});

// soporte táctil: tocar una aguja → probar
document.getElementById('needleGrid').addEventListener('click', (e)=>{
  const el = e.target.closest('.needle'); if(!el) return;
  const src = el.querySelector('img').getAttribute('src');
  testNeedle(src);
});

function testNeedle(src){
  // limpia anterior
  slot.innerHTML = '';
  const im = new Image();
  im.src = src; im.className = 'placed';
  slot.appendChild(im);

  if(src.includes('aguja_luz')){
    slot.classList.add('flash');
    setTimeout(()=> slot.classList.remove('flash'), 800);
    msg.textContent = messages['aguja_luz.png'];
    slotLocked = true;
  }else{
    msg.textContent = messages[src.split('/').pop()] || 'No encaja. Prueba otra.';
  }
}

/* ===========================================================
   Arranque: deja dos piezas iniciales en escena (puedes quitarlo)
   =========================================================== */
addPiece('silueta_a.png', 'silueta', 30, 80, 1);
addPiece('silueta_b.png', 'silueta', 55, 82, 1);
</script>
</body>
</html>

