<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pista 3 — Taller de relojería</title>
<style>
  :root{
    --bg:#0b0b0b; --ink:#eee; --muted:#bdbdbd; --accent:#ffd166; --panel:rgba(0,0,0,.6);
    --chip:#fff; --chipText:#000;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6}

  /* ===== ESCENA VÍDEO ===== */
  .stage{position:relative;min-height:100vh;display:grid;place-items:center;background:#000}
  .videoWrap{position:relative;width:min(100vw,1200px);aspect-ratio:16/9;background:#000;overflow:hidden;border-radius:14px}
  video{width:100%;height:100%;display:block;object-fit:cover}
  .overlay-quote{position:absolute;inset:0;display:grid;place-items:end center;padding:7vh 6vw 9vh;text-align:center;pointer-events:none}
  .overlay-quote p{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(18px,1.6vw,30px);line-height:1.5;text-shadow:0 3px 14px rgba(0,0,0,.85);opacity:0;transform:translateY(12px);transition:opacity .8s ease,transform .8s ease}
  .overlay-quote.show p{opacity:1;transform:none}
  .goTaller{position:absolute;right:16px;bottom:16px;z-index:5;background:var(--panel);border:1px solid rgba(255,255,255,.55);color:#fff;font-weight:800;border-radius:12px;padding:10px 14px;cursor:pointer;display:none;backdrop-filter:blur(3px)}
  .goTaller.show{display:inline-flex}

  /* ===== TALLER ===== */
  .taller{display:none;min-height:100vh;padding:24px 20px 40px;background:#0a0a0a;
    background-image:url('p03.png');background-size:cover;background-position:center;background-repeat:no-repeat}
  .scrim{backdrop-filter:blur(3px);background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.75));padding:18px;border-radius:16px}
  .wrap{max-width:1200px;margin:0 auto;display:grid;gap:18px}
  .grid{display:grid;gap:16px;grid-template-columns:1.1fr .9fr}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .panel{background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:16px 16px 18px;box-shadow:0 20px 50px rgba(0,0,0,.55)}
  .panel h2{margin:.2rem 0 6px;font-size:1.2rem}
  .muted{color:var(--muted);margin:0 0 10px;font-style:italic}
  .chips{display:flex;flex-wrap:wrap;gap:10px}
  .chip{appearance:none;border:1px solid #fff;background:var(--chip);color:var(--chipText);border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer}
  .chip.ghost{background:transparent;color:#fff;border-color:#fff}
  .chip:active{transform:translateY(1px)}
  .chip[data-active="1"]{box-shadow:0 0 0 3px var(--accent) inset}
  .mezcla{display:grid;gap:10px;grid-template-columns:1fr 1fr;align-items:center}
  .slot{background:#111;border:1px dashed #666;border-radius:12px;min-height:70px;display:grid;place-items:center;padding:8px;text-align:center}
  .slot small{color:#aaa}
  .resultado{height:90px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:#111;box-shadow:inset 0 2px 8px rgba(0,0,0,.12)}
  .tools{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .list{display:grid;gap:10px}
  .formula{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);padding:10px;border-radius:12px}
  .swatch{width:28px;height:28px;border-radius:50%;border:2px solid rgba(255,255,255,.6);flex:0 0 auto}

  /* ===== PUZZLE ===== */
  .puz-panel{background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:16px}
  .puz-board{display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(2,1fr);gap:18px;margin-top:12px}
  .puz-cell{position:relative;background:#0e0e0e;border-radius:16px;outline:2px dashed rgba(255,255,255,.25);min-height:170px;overflow:hidden}
  .puz-cell .piece{position:absolute;inset:0;background-image:url('p03.png');background-repeat:no-repeat;border-radius:14px}
  @media (max-width:640px){.puz-cell{min-height:120px}}
  .puz-tray{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;margin:18px 0 8px}
  .tray-piece{width:120px;aspect-ratio:3/2;border-radius:14px;background-image:url('p03.png');background-repeat:no-repeat;outline:2px solid rgba(255,255,255,.3);box-shadow:0 8px 24px rgba(0,0,0,.45);cursor:pointer;touch-action:none}
  .tray-piece.sel{outline:4px solid var(--accent)}
  .puz-actions{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:8px}
  .celebra{position:relative;margin-top:10px}
  .celebra .flash{position:absolute;inset:0;border-radius:16px;pointer-events:none;opacity:0}
  .puz-complete .flash{animation:flash .9s ease forwards}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(255,255,0,.0);opacity:0}30%{box-shadow:0 0 0 8px rgba(255,255,0,.35);opacity:1}100%{box-shadow:0 0 0 0 rgba(255,255,0,0);opacity:0}}
  .frase-final{display:none;margin-top:16px;text-align:center;font-weight:800}
  .puz-complete .frase-final{display:block}

  .ttl{margin:0 0 4px;font-size:clamp(1.2rem,1rem + 1vw,1.6rem)}
  .sub{margin:0 0 10px;color:#e0e0e0;opacity:.9}
  .taller.noimg{background:#0b0b0b}
</style>
</head>
<body>

<!-- ===== ESCENA VÍDEO ===== -->
<section class="stage" id="scene">
  <div class="videoWrap">
    <video id="vid" playsinline preload="auto" controls>
      <source src="p03.mp4" type="video/mp4"/>
      Tu navegador no puede reproducir este vídeo.
    </video>
    <div class="overlay-quote" id="quote">
      <p>“El silencio perdura entre las agujas.<br>Escucha bien: no todo lo que se mueve, avanza.”</p>
    </div>
    <button class="goTaller" id="goTaller">Ir al taller ⟶</button>
  </div>
</section>

<!-- ===== TALLER ===== -->
<section class="taller" id="taller">
  <div class="wrap">
    <header class="scrim panel">
      <h1 class="ttl">Taller de relojería</h1>
      <p class="sub">Mezcla barnices y compuestos como lo haría un relojero antiguo. Guarda las fórmulas que te parezcan prometedoras.</p>
      <div class="tools">
        <button class="chip ghost" id="backVideo">⟵ Volver al vídeo</button>
        <button class="chip" id="volverPistas">Volver a las pistas</button>
      </div>
    </header>

    <div class="grid">
      <!-- Ingredientes -->
      <div class="panel scrim">
        <h2>Frascos y compuestos</h2>
        <p class="muted">Pulsa dos frascos para enviarlos a los slots A y B. Luego “Mezclar”.</p>
        <div class="chips" id="frascos">
          <button class="chip" data-name="Goma laca"        data-color="#d9a76c">Goma laca</button>
          <button class="chip" data-name="Alcohol etílico"  data-color="#d7e9ff">Alcohol etílico</button>
          <button class="chip" data-name="Dióxido de zinc"  data-color="#f4f4f4">Dióxido de zinc</button>
          <button class="chip" data-name="Óxido de hierro"  data-color="#9b4a2f">Óxido de hierro</button>
          <button class="chip" data-name="Aceite de linaza" data-color="#f3d27a">Aceite de linaza</button>
          <button class="chip" data-name="Betún de judea"   data-color="#2b1c12">Betún de judea</button>
          <button class="chip" data-name="Barniz copal"     data-color="#eecb8b">Barniz copal</button>
          <button class="chip" data-name="Sulfuro de zinc (ZnS)" data-color="#c9ffe6">Sulfuro de zinc (ZnS)</button>
          <button class="chip" data-name="Sales de cobre"   data-color="#00ff99">Sales de cobre</button>
          <button class="chip" data-name="Sales de plata"   data-color="#00ccff">Sales de plata</button>
          <button class="chip" data-name="Radio-226"        data-color="#d4ff00">Radio-226</button>
        </div>

        <div class="mezcla" style="margin-top:12px">
          <div class="slot" id="slotA"><small>Slot A</small></div>
          <div class="slot" id="slotB"><small>Slot B</small></div>
          <div class="resultado" id="resultado" style="grid-column:1/-1"></div>
        </div>

        <div class="tools">
          <button class="chip" id="resolver">Mezclar</button>
          <button class="chip ghost" id="guardar">Guardar fórmula</button>
          <button class="chip ghost" id="limpiar">Limpiar</button>
        </div>
      </div>

      <!-- Fórmulas + PUZLE -->
      <div class="panel scrim">
        <h2>Fórmulas guardadas</h2>
        <div class="list" id="lista"></div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.15);margin:14px 0">
        <h2>Puzle del banco de relojero</h2>
        <p class="muted">Descubre las 6 piezas y colócalas en su sitio. Toca una pieza para seleccionarla y luego una casilla para colocarla. Vuelve a tocar la casilla para recuperarla.</p>

        <div class="puz-panel celebra" id="puzPanel">
          <div class="puz-board" id="board" aria-label="Tablero 3x2">
            <div class="puz-cell" data-i="0"></div>
            <div class="puz-cell" data-i="1"></div>
            <div class="puz-cell" data-i="2"></div>
            <div class="puz-cell" data-i="3"></div>
            <div class="puz-cell" data-i="4"></div>
            <div class="puz-cell" data-i="5"></div>
          </div>

          <div class="puz-tray" id="tray"></div>

          <div class="puz-actions">
            <button class="chip" id="pzDiscover">Descubrir pieza</button>
            <button class="chip" id="pzSave">Guardar puzzle</button>
            <button class="chip ghost" id="pzReset">Desarmar puzzle</button>
            <button class="chip" id="volverPistas2">Volver a pistas</button>
          </div>

          <div class="flash"></div>
          <p class="frase-final" id="puzFrase">A veces, el tiempo se reconoce en su engranaje.</p>
        </div>

        <p class="muted" style="margin-top:8px">Imagen base: <em>p03.png</em>.</p>
      </div>
    </div>
  </div>
</section>

<script>
/* ====== VÍDEO + NAVEGACIÓN ====== */
(() => {
  const vid   = document.getElementById('vid');
  const quote = document.getElementById('quote');
  const goBtn = document.getElementById('goTaller');
  const scene = document.getElementById('scene');
  const taller= document.getElementById('taller');

  function showQuote(){ quote.classList.add('show'); }
  vid.addEventListener('play', () => { showQuote(); setTimeout(()=>goBtn.classList.add('show'), 2000); });
  vid.addEventListener('ended', () => goBtn.classList.add('show'));

  function openTaller(){
    scene.style.display='none'; taller.style.display='block';
    const url = getComputedStyle(taller).backgroundImage; if(!url || url==='none') taller.classList.add('noimg');
  }
  goBtn.addEventListener('click', openTaller);

  document.getElementById('backVideo').addEventListener('click', ()=>{ taller.style.display='none'; scene.style.display='grid'; vid.focus(); });
  document.getElementById('volverPistas').addEventListener('click', ()=>{ location.href='index.html'; });
  document.getElementById('volverPistas2').addEventListener('click', ()=>{ location.href='index.html'; });
})();

/* ====== TALLER (mezclas) ====== */
(() => {
  const slotA = document.getElementById('slotA');
  const slotB = document.getElementById('slotB');
  const res   = document.getElementById('resultado');
  const lista = document.getElementById('lista');
  const SKEY_FORM='p03_formulas';
  let selA=null, selB=null;

  document.getElementById('frascos').addEventListener('click', (e)=>{
    const btn=e.target.closest('.chip'); if(!btn) return;
    const item={name:btn.dataset.name,color:btn.dataset.color};
    if(!selA){ selA=item; pinta(slotA,selA); marca(btn); return; }
    if(!selB && item.name!==selA.name){ selB=item; pinta(slotB,selB); marca(btn); return; }
    limpia();
    selA=item; pinta(slotA,selA); marca(btn,true);
  });
  function marca(btn,only){ if(only){document.querySelectorAll('.chip[data-active="1"]').forEach(b=>b.dataset.active='0');} btn.dataset.active=btn.dataset.active==='1'?'0':'1'; }
  function pinta(slot,data){ slot.innerHTML='<strong>'+data.name+'</strong>'; slot.style.borderColor=data.color; slot.style.boxShadow='0 0 0 3px '+data.color+'20 inset'; }
  function limpia(){ selA=selB=null; slotA.innerHTML='<small>Slot A</small>'; slotB.innerHTML='<small>Slot B</small>'; slotA.style=slotB.style=''; res.style.background='#111'; res.dataset.color=''; }
  function hex2rgb(h){const c=h.replace('#','');return{r:parseInt(c.slice(0,2),16),g:parseInt(c.slice(2,4),16),b:parseInt(c.slice(4,6),16)}}
  function rgb2hex(r,g,b){const t=v=>('0'+v.toString(16)).slice(-2);return '#'+t(r)+t(g)+t(b)}
  function mix(a,b){const A=hex2rgb(a),B=hex2rgb(b);return rgb2hex(Math.round((A.r+B.r)/2),Math.round((A.g+B.g)/2),Math.round((A.b+B.b)/2))}
  document.getElementById('resolver').addEventListener('click',()=>{ if(!selA||!selB) return alert('Elige dos frascos (A y B).'); const color=mix(selA.color,selB.color); res.style.background=color; res.dataset.color=color; });
  document.getElementById('limpiar').addEventListener('click',()=>{ limpia(); document.querySelectorAll('.chip[data-active="1"]').forEach(b=>b.dataset.active='0'); });
  document.getElementById('guardar').addEventListener('click',()=>{ const color=res.dataset.color; if(!selA||!selB||!color) return alert('Mezcla primero dos frascos.'); const arr=carga(SKEY_FORM); arr.push({a:selA.name,b:selB.name,color,ts:Date.now()}); guarda(SKEY_FORM,arr); pintaLista(); });
  function pintaLista(){ const arr=carga(SKEY_FORM); if(!arr.length){lista.innerHTML='<em class="muted">(Vacío)</em>'; return;} lista.innerHTML=arr.map(it=>`<div class="formula"><span class="swatch" style="background:${it.color}"></span><div style="flex:1 1 auto"><strong>${it.a}</strong> + <strong>${it.b}</strong><br><small style="color:#ccc">${new Date(it.ts).toLocaleString()}</small></div><button class="chip ghost" data-del="${it.ts}">Eliminar</button></div>`).join(''); }
  lista.addEventListener('click',(e)=>{ const del=e.target.closest('[data-del]'); if(!del) return; const ts=+del.dataset.del; const arr=carga(SKEY_FORM).filter(x=>x.ts!==ts); guarda(SKEY_FORM,arr); pintaLista(); });
  function carga(k){ try{return JSON.parse(localStorage.getItem(k)||'[]')}catch(_){return[]} }
  function guarda(k,v){ localStorage.setItem(k,JSON.stringify(v)); }
  pintaLista();
})();

/* ====== PUZZLE (sprite por píxeles; compatible móvil) ====== */
(() => {
  const N=6, COLS=3, ROWS=2;
  const board=document.getElementById('board');
  const tray =document.getElementById('tray');
  const panel=document.getElementById('puzPanel');
  const discoverBtn=document.getElementById('pzDiscover');
  const resetBtn=document.getElementById('pzReset');
  const saveBtn=document.getElementById('pzSave');

  let bag=[], trayPieces=[], placed=Array(N).fill(null), selected=null;
  let SPR_W=0, SPR_H=0, TILE_W=0, TILE_H=0;

  const img=new Image();
  img.onload=()=>{
    SPR_W=img.naturalWidth; SPR_H=img.naturalHeight;
    TILE_W=Math.floor(SPR_W/COLS);
    TILE_H=Math.floor(SPR_H/ROWS);
    initPuzzle();
  };
  img.src='p03.png';

  function shuffle(arr){
    if(window.crypto&&crypto.getRandomValues){
      for(let i=arr.length-1;i>0;i--){
        const r=new Uint32Array(1); crypto.getRandomValues(r);
        const j=r[0]%(i+1); [arr[i],arr[j]]=[arr[j],arr[i]];
      }
    }else{
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];
      }
    }
    return arr;
  }
  function refillBag(){ bag=shuffle([...Array(N).keys()]); }

  function bgFor(id){
    const col=id%COLS, row=Math.floor(id/COLS);
    const x=-(col*TILE_W), y=-(row*TILE_H);
    return {pos:`${x}px ${y}px`, size:`${SPR_W}px ${SPR_H}px`};
  }

  function renderTray(){
    tray.innerHTML='';
    trayPieces.forEach(id=>{
      const d=document.createElement('div');
      d.className='tray-piece'+(selected===id?' sel':'');
      const s=bgFor(id);
      d.style.backgroundPosition=s.pos;
      d.style.backgroundSize=s.size;
      d.dataset.id=id;
      d.onclick=()=>{ selected=(selected===id)?null:id; renderTray(); };
      tray.appendChild(d);
    });
  }

  function renderBoard(){
    board.querySelectorAll('.puz-cell').forEach(cell=>{
      const i=+cell.dataset.i; cell.innerHTML='';
      if(placed[i]!==null){
        const p=document.createElement('div');
        p.className='piece';
        const s=bgFor(placed[i]);
        p.style.backgroundPosition=s.pos;
        p.style.backgroundSize=s.size;
        cell.appendChild(p);
      }
      cell.onclick=()=>onCellTap(i);
    });
  }

  function onCellTap(i){
    if(placed[i]!==null){
      trayPieces.push(placed[i]);
      placed[i]=null; selected=null;
      renderBoard(); renderTray(); checkComplete();
      return;
    }
    if(selected===null) return;
    placed[i]=selected;
    trayPieces=trayPieces.filter(x=>x!==selected);
    selected=null;
    renderBoard(); renderTray(); checkComplete();
  }

  function discoverPiece(){
    if(trayPieces.length+placed.filter(x=>x!==null).length>=N) return;
    if(bag.length===0) refillBag();
    while(bag.length){
      const id=bag.shift();
      if(!trayPieces.includes(id) && !placed.includes(id)){
        trayPieces.push(id); break;
      }
    }
    renderTray();
  }

  function resetPuzzle(){
    refillBag(); trayPieces=[]; placed=Array(N).fill(null); selected=null;
    renderTray(); renderBoard(); panel.classList.remove('puz-complete');
  }

  function savePuzzle(){
    localStorage.setItem('p03_puzzle', JSON.stringify({tray:trayPieces,placed}));
    saveBtn.textContent='¡Guardado!'; setTimeout(()=>saveBtn.textContent='Guardar puzzle',1200);
  }
  function loadPuzzle(){
    try{
      const s=JSON.parse(localStorage.getItem('p03_puzzle')||'null');
      if(!s){ resetPuzzle(); return; }
      trayPieces=s.tray||[]; placed=Array.isArray(s.placed)?s.placed:Array(N).fill(null);
      refillBag(); renderTray(); renderBoard(); checkComplete();
    }catch(_){ resetPuzzle(); }
  }

  function checkComplete(){
    const ok=placed.every((id,i)=>id===i);
    panel.classList.toggle('puz-complete', ok);
  }

  function initPuzzle(){
    refillBag();
    renderBoard();
    loadPuzzle();
    discoverBtn.onclick=discoverPiece;
    resetBtn.onclick=resetPuzzle;
    saveBtn.onclick=savePuzzle;
  }
})();
</script>
</body>
</html>









