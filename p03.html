<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pista 3 — Taller de relojería</title>
<style>
  :root{
    --bg:#0b0b0b; --ink:#eee; --muted:#bdbdbd; --accent:#ffd166; --panel:rgba(0,0,0,.6);
    --chip:#fff; --chipText:#000;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6}

  /* ===== ESCENA VÍDEO ===== */
  .stage{position:relative;min-height:100vh;display:grid;place-items:center;background:#000}
  .videoWrap{position:relative;width:min(100vw,1200px);aspect-ratio:16/9;background:#000;overflow:hidden;border-radius:14px}
  video{width:100%;height:100%;display:block;object-fit:cover}

  .overlay-quote{
    position:absolute;inset:0;display:grid;place-items:end center;
    padding:7vh 6vw 9vh; text-align:center; pointer-events:none;
  }
  .overlay-quote p{
    margin:0; font-weight:800; letter-spacing:.2px;
    font-size:clamp(18px,1.6vw,30px); line-height:1.5;
    text-shadow:0 3px 14px rgba(0,0,0,.85);
    opacity:0; transform:translateY(12px); transition:opacity .8s ease, transform .8s ease;
  }
  .overlay-quote.show p{opacity:1; transform:none}

  .goTaller{
    position:absolute; right:16px; bottom:16px; z-index:5;
    background:var(--panel); border:1px solid rgba(255,255,255,.55);
    color:#fff; font-weight:800; border-radius:12px; padding:10px 14px; cursor:pointer; display:none;
    backdrop-filter:blur(3px);
  }
  .goTaller.show{display:inline-flex}

  /* ===== TALLER ===== */
  .taller{display:none; min-height:100vh; padding:24px 20px 40px; background:#0a0a0a;
    background-image: url('p03.png');
    background-size:cover; background-position:center; background-repeat:no-repeat;
  }
  .scrim{backdrop-filter:blur(3px); background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.75)); padding:18px; border-radius:16px}
  .wrap{max-width:1200px;margin:0 auto;display:grid;gap:18px}
  .grid{display:grid; gap:16px; grid-template-columns: 1.1fr .9fr;}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .panel{
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.18);
    border-radius:16px; padding:16px 16px 18px; box-shadow:0 20px 50px rgba(0,0,0,.55);
  }
  .panel h2{margin:.2rem 0 6px; font-size:1.2rem}
  .muted{color:var(--muted); margin:0 0 10px; font-style:italic}

  .chips{display:flex; flex-wrap:wrap; gap:10px}
  .chip{
    appearance:none; border:1px solid #fff; background:var(--chip); color:var(--chipText);
    border-radius:999px; padding:8px 12px; font-weight:800; cursor:pointer;
  }
  .chip.ghost{background:transparent;color:#fff;border-color:#fff}
  .chip:active{transform:translateY(1px)}
  .chip[data-active="1"]{box-shadow:0 0 0 3px var(--accent) inset}

  .mezcla{display:grid; gap:10px; grid-template-columns:1fr 1fr; align-items:center;}
  .slot{
    background:#111; border:1px dashed #666; border-radius:12px; min-height:70px;
    display:grid; place-items:center; padding:8px; text-align:center;
  }
  .slot small{color:#aaa}
  .resultado{
    height:90px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background:#111; box-shadow:inset 0 2px 8px rgba(0,0,0,.12);
  }
  .tools{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}

  .list{display:grid; gap:10px}
  .formula{
    display:flex; align-items:center; gap:10px; background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.18); padding:10px; border-radius:12px;
  }
  .swatch{width:28px;height:28px;border-radius:50%;border:2px solid rgba(255,255,255,.6);flex:0 0 auto}

  .ttl{margin:0 0 4px; font-size:clamp(1.2rem,1rem + 1vw,1.6rem)}
  .sub{margin:0 0 10px; color:#e0e0e0; opacity:.9}
  .taller.noimg{background:#0b0b0b}

  /* ====== PUZLE ====== */
  .pz-board{
    background:#0a0a0a; border:1px solid rgba(255,255,255,.18);
    border-radius:16px; padding:14px; box-shadow: inset 0 2px 10px rgba(0,0,0,.35);
    position:relative; /* para el banner */
  }
  .pz-grid{
    display:grid; grid-template-columns:repeat(3, 1fr); grid-template-rows:repeat(2, 1fr);
    gap:14px; height:min(48vw, 520px);
  }
  .pz-cell{
    background:#111; border:2px dashed rgba(255,255,255,.25);
    border-radius:14px; position:relative; overflow:hidden;
  }
  .pz-cell[aria-filled="true"]{ border-style:solid; }
  .pz-cell.dragover{ outline:2px solid var(--accent); outline-offset:2px; }

  .pz-tray{
    display:flex; flex-wrap:wrap; gap:10px; padding:10px; margin-top:14px;
    background:#0a0a0a; border:1px solid rgba(255,255,255,.18); border-radius:12px;
    min-height:100px;
  }
  .pz-empty{ color:#bbb; font-style:italic; opacity:.85; }

  .pz-piece{
    width:140px; height:100px;
    background-image:url('p03.png');
    background-size:300% 200%;
    background-repeat:no-repeat;
    border-radius:10px; border:1px solid rgba(255,255,255,.25);
    cursor:grab; user-select:none;
  }
  .pz-piece:active{ cursor:grabbing; }

  .pz-flash{ animation: flash 700ms ease-out 1; }
  @keyframes flash{
    0%{ box-shadow:0 0 0 rgba(255,255,255,0) }
    50%{ box-shadow:0 0 30px rgba(255,255,200,.85) }
    100%{ box-shadow:0 0 0 rgba(255,255,255,0) }
  }

  /* Brillo del marco al completar */
  .pz-board.pz-complete{
    animation: glow 1500ms ease-out 1;
    box-shadow:
      0 0 0 2px rgba(255,255,200,.65),
      0 0 40px rgba(255,255,160,.35),
      inset 0 0 35px rgba(255,255,180,.18);
  }
  @keyframes glow{
    0%{ box-shadow:0 0 0 0 rgba(255,255,200,0) }
    60%{ box-shadow:0 0 0 3px rgba(255,255,200,.85), 0 0 60px rgba(255,255,160,.45), inset 0 0 50px rgba(255,255,200,.25) }
    100%{ box-shadow:0 0 0 2px rgba(255,255,200,.65), 0 0 40px rgba(255,255,160,.35), inset 0 0 35px rgba(255,255,180,.18) }
  }

  /* Banner con la frase final */
  .pz-banner{
    position:absolute; inset:0; display:grid; place-items:center;
    pointer-events:none; opacity:0; transition:opacity .6s ease .2s;
  }
  .pz-banner.show{ opacity:1; }
  .pz-banner .pill{
    background:rgba(0,0,0,.62);
    border:1px solid rgba(255,255,255,.5);
    padding:14px 18px; border-radius:14px; text-align:center; font-weight:800;
    box-shadow:0 0 28px rgba(255,255,200,.55);
    max-width:min(90%,780px);
  }

  .pz-actions{ display:flex; flex-wrap:wrap; gap:12px; margin-top:14px }
  .pz-btn{
    background:#fff; color:#000; border:1px solid #fff; border-radius:999px;
    padding:10px 14px; font-weight:800; cursor:pointer;
  }
  .pz-btn.ghost{ background:transparent; color:#fff; border-color:#fff }
  .pz-btn:active{ transform:translateY(1px) }

  @media (max-width:960px){
    .pz-piece{ width:116px; height:82px; }
  }
</style>
</head>
<body>

<!-- ====== ESCENA VÍDEO ====== -->
<section class="stage" id="scene">
  <div class="videoWrap">
    <video id="vid" playsinline preload="auto" controls>
      <source src="p03.mp4" type="video/mp4"/>
      Tu navegador no puede reproducir este vídeo.
    </video>
    <div class="overlay-quote" id="quote">
      <p>“El silencio perdura entre las agujas.<br>Escucha bien: no todo lo que se mueve, avanza.”</p>
    </div>
    <button class="goTaller" id="goTaller">Ir al taller ⟶</button>
  </div>
</section>

<!-- ====== TALLER ====== -->
<section class="taller" id="taller">
  <div class="wrap">
    <header class="scrim panel">
      <h1 class="ttl">Taller de relojería</h1>
      <p class="sub">Mezcla barnices y compuestos como lo haría un relojero antiguo. Guarda las fórmulas que te parezcan prometedoras.</p>
      <div class="tools">
        <button class="chip ghost" id="backVideo">⟵ Volver al vídeo</button>
        <button class="chip" id="volverPistas">Volver a las pistas</button>
      </div>
    </header>

    <div class="grid">
      <!-- Columna izquierda: frascos y mezcla -->
      <div class="panel scrim">
        <h2>Frascos y compuestos</h2>
        <p class="muted">Pulsa dos frascos para enviarlos a los slots A y B. Luego “Mezclar”.</p>
        <div class="chips" id="frascos">
          <button class="chip" data-name="Goma laca"        data-color="#d9a76c">Goma laca</button>
          <button class="chip" data-name="Alcohol etílico"  data-color="#d7e9ff">Alcohol etílico</button>
          <button class="chip" data-name="Dióxido de zinc"  data-color="#f4f4f4">Dióxido de zinc</button>
          <button class="chip" data-name="Óxido de hierro"  data-color="#9b4a2f">Óxido de hierro</button>
          <button class="chip" data-name="Aceite de linaza" data-color="#f3d27a">Aceite de linaza</button>
          <button class="chip" data-name="Betún de judea"   data-color="#2b1c12">Betún de judea</button>
          <button class="chip" data-name="Barniz copal"     data-color="#eecb8b">Barniz copal</button>
          <!-- pista luminiscente opcional -->
          <button class="chip" data-name="Sulfuro de zinc (ZnS)" data-color="#c9ffe6">Sulfuro de zinc (ZnS)</button>
          <button class="chip" data-name="Sales de cobre" data-color="#00ff99">Sales de cobre</button>
          <button class="chip" data-name="Sales de plata" data-color="#00ccff">Sales de plata</button>
          <button class="chip" data-name="Radio-226" data-color="#d4ff00">Radio-226</button>
        </div>

        <div class="mezcla" style="margin-top:12px">
          <div class="slot" id="slotA"><small>Slot A</small></div>
          <div class="slot" id="slotB"><small>Slot B</small></div>
          <div class="resultado" id="resultado" style="grid-column:1/-1"></div>
        </div>

        <div class="tools">
          <button class="chip" id="resolver">Mezclar</button>
          <button class="chip ghost" id="guardar">Guardar fórmula</button>
          <button class="chip ghost" id="limpiar">Limpiar</button>
        </div>
      </div>

      <!-- Columna derecha: fórmulas guardadas y PUZLE -->
      <div class="panel scrim">
        <h2>Fórmulas guardadas</h2>
        <div class="list" id="lista"></div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.15);margin:14px 0">

        <!-- ===== PUZLE ===== -->
        <h2>Puzle del banco de relojero</h2>
        <p class="muted">Descubre las 6 piezas y colócalas en su sitio. Cuando encajen todas, verás lo que dijo Tomás.</p>

        <div class="pz-board" id="pzBoard">
          <div class="pz-grid" id="pzGrid">
            <div class="pz-cell" data-idx="0" aria-filled="false"></div>
            <div class="pz-cell" data-idx="1" aria-filled="false"></div>
            <div class="pz-cell" data-idx="2" aria-filled="false"></div>
            <div class="pz-cell" data-idx="3" aria-filled="false"></div>
            <div class="pz-cell" data-idx="4" aria-filled="false"></div>
            <div class="pz-cell" data-idx="5" aria-filled="false"></div>
          </div>
          <!-- Banner con la frase final -->
          <div class="pz-banner" id="pzBanner">
            <div class="pill">“A veces, el tiempo se reconoce en su engranaje.”</div>
          </div>
        </div>

        <div class="pz-tray" id="pzTray">
          <span class="pz-empty" id="pzEmpty">(Pulsa “Descubrir pieza” para sacar la primera)</span>
        </div>

        <div class="pz-actions">
          <button class="pz-btn" id="pzDiscover">Descubrir pieza</button>
          <button class="pz-btn" id="pzSave">Guardar puzzle</button>
          <button class="pz-btn ghost" id="pzReset">Desarmar puzzle</button>
          <button class="pz-btn ghost" id="pzBack">Volver a pistas</button>
        </div>

        <p class="muted" style="margin-top:8px">Imagen base: <em>p03.png</em>. Piezas: arrástralas a una casilla. Haz clic sobre una pieza colocada para devolverla a la bandeja.</p>
        <!-- ===== FIN PUZLE ===== -->
      </div>
    </div>
  </div>
  /* Piezas del puzzle: fondo siempre del mismo sprite */
.pz-piece{
  background-image: url('p03.png'); /* misma imagen base del taller */
  background-repeat: no-repeat;
  /* Para rejilla 3x2: 300% x 200% fija */
  background-size: 300% 200% !important;
  touch-action: none; /* mejor arrastre en móvil */
}

</section>

<script>
(function(){
  /* ===== VÍDEO + NAVEGACIÓN ===== */
  const vid   = document.getElementById('vid');
  const quote = document.getElementById('quote');
  const goBtn = document.getElementById('goTaller');
  const scene = document.getElementById('scene');
  const taller= document.getElementById('taller');

  function showQuote(){ quote.classList.add('show'); }
  vid.addEventListener('play', ()=>{ showQuote(); setTimeout(()=> goBtn.classList.add('show'), 2000); });
  vid.addEventListener('ended', ()=> goBtn.classList.add('show'));
  goBtn.addEventListener('click', openTaller);
  function openTaller(){
    scene.style.display = 'none';
    taller.style.display = 'block';
    const url = getComputedStyle(taller).backgroundImage;
    if (!url || url === 'none') taller.classList.add('noimg');
  }
  document.getElementById('backVideo').addEventListener('click', ()=>{
    taller.style.display = 'none';
    scene.style.display  = 'grid';
    vid.focus();
  });
  document.getElementById('volverPistas').addEventListener('click', ()=>{ window.location.href = 'index.html'; });

  /* ===== MEZCLAS ===== */
  const slotA = document.getElementById('slotA');
  const slotB = document.getElementById('slotB');
  const res   = document.getElementById('resultado');
  const lista = document.getElementById('lista');

  const SKEY_FORM = 'p03_formulas';

  let selA = null, selB = null;

  document.getElementById('frascos').addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip'); if(!btn) return;
    const item = { name: btn.dataset.name, color: btn.dataset.color };

    if(!selA){ selA = item; renderSlot(slotA, selA); mark(btn); return; }
    if(!selB && item.name !== selA.name){ selB = item; renderSlot(slotB, selB); mark(btn); return; }

    clearSlots(); selA = item; renderSlot(slotA, selA); mark(btn,true);
  });

  function mark(btn, only){
    if(only){ document.querySelectorAll('.chip[data-active="1"]').forEach(b=>b.dataset.active='0'); }
    btn.dataset.active = btn.dataset.active === '1' ? '0' : '1';
  }
  function renderSlot(slot, data){
    slot.innerHTML = '<strong>'+data.name+'</strong>';
    slot.style.borderColor = data.color;
    slot.style.boxShadow   = '0 0 0 3px '+data.color+'20 inset';
  }
  function clearSlots(){
    selA = selB = null;
    slotA.innerHTML = '<small>Slot A</small>';
    slotB.innerHTML = '<small>Slot B</small>';
    slotA.style = slotB.style = '';
    res.style.background = '#111'; res.dataset.color = '';
  }

  function hex2rgb(h){ const c = h.replace('#',''); return { r:parseInt(c.slice(0,2),16), g:parseInt(c.slice(2,4),16), b:parseInt(c.slice(4,6),16) }; }
  function rgb2hex(r,g,b){ const to=v=>('0'+v.toString(16)).slice(-2); return '#'+to(r)+to(g)+to(b); }
  function mix(a,b){ const A=hex2rgb(a), B=hex2rgb(b); return rgb2hex(Math.round((A.r+B.r)/2),Math.round((A.g+B.g)/2),Math.round((A.b+B.b)/2)); }

  document.getElementById('resolver').addEventListener('click', ()=>{
    if(!selA || !selB) return alert('Elige dos frascos (A y B).');
    const color = mix(selA.color, selB.color);
    res.style.background = color; res.dataset.color = color;
  });

  document.getElementById('limpiar').addEventListener('click', ()=>{
    clearSlots();
    document.querySelectorAll('.chip[data-active="1"]').forEach(b=>b.dataset.active='0');
  });

  document.getElementById('guardar').addEventListener('click', ()=>{
    const color = res.dataset.color;
    if(!selA || !selB || !color) return alert('Mezcla primero dos frascos.');
    const entry = { a: selA.name, b: selB.name, color, ts: Date.now() };
    const arr = load(SKEY_FORM); arr.push(entry); save(SKEY_FORM, arr); paintList();
  });

  function paintList(){
    const arr = load(SKEY_FORM);
    if(!arr.length){ lista.innerHTML = '<em class="muted">(Vacío)</em>'; return; }
    lista.innerHTML = arr.map(it => `
      <div class="formula">
        <span class="swatch" style="background:${it.color}"></span>
        <div style="flex:1 1 auto">
          <strong>${it.a}</strong> + <strong>${it.b}</strong><br>
          <small style="color:#ccc">${new Date(it.ts).toLocaleString()}</small>
        </div>
        <button class="chip ghost" data-del="${it.ts}">Eliminar</button>
      </div>
    `).join('');
  }
  lista.addEventListener('click', (e)=>{
    const del = e.target.closest('[data-del]'); if(!del) return;
    const ts = Number(del.dataset.del);
    const arr = load(SKEY_FORM).filter(x => x.ts !== ts);
    save(SKEY_FORM, arr); paintList();
  });

  function load(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch(_){ return []; } }
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  paintList();

  /* ===== PUZLE ===== */
  const IMG = 'p03.png';
  const CELLS = 6;                 // 3 x 2
  const SKEY_PZ = 'p03_puzzle_v1';

  const board = document.getElementById('pzBoard');
  const banner = document.getElementById('pzBanner');
  const grid = document.getElementById('pzGrid');
  const tray = document.getElementById('pzTray');
  const emptyMsg = document.getElementById('pzEmpty');

  const btnDiscover = document.getElementById('pzDiscover');
  const btnSave = document.getElementById('pzSave');
  const btnReset = document.getElementById('pzReset');
  const btnBack = document.getElementById('pzBack');

  const positions = ['0% 0%','50% 0%','100% 0%','0% 100%','50% 100%','100% 100%'];

  let state = new Array(CELLS).fill(null);

  function renderEmptyMsg(){
    const hasPieces = tray.querySelector('.pz-piece');
    emptyMsg.style.display = hasPieces ? 'none' : 'inline';
  }

  function mkPiece(idx){
    const el = document.createElement('div');
    el.className = 'pz-piece';
    el.draggable = true;
    el.dataset.idx = String(idx);
    el.style.backgroundImage = `url('${IMG}')`;
    el.style.backgroundPosition = positions[idx];
    el.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/piece', idx); });
    return el;
  }
  function addToTray(idx){
    if (tray.querySelector(`.pz-piece[data-idx="${idx}"]`)) return;
    const piece = mkPiece(idx);
    tray.appendChild(piece);
    renderEmptyMsg();
  }

  btnDiscover.addEventListener('click', ()=>{
    const used = new Set([
      ...Array.from(tray.querySelectorAll('.pz-piece')).map(p => Number(p.dataset.idx)),
      ...state.filter(v => v !== null)
    ]);
    const remaining = [...Array(CELLS).keys()].filter(i => !used.has(i));
    if(!remaining.length){ alert('Ya has descubierto las 6 piezas.'); return; }
    const rand = remaining[Math.floor(Math.random()*remaining.length)];
    addToTray(rand);
    tray.classList.add('pz-flash'); setTimeout(()=> tray.classList.remove('pz-flash'), 450);
  });

  grid.querySelectorAll('.pz-cell').forEach(cell=>{
    cell.addEventListener('dragover', e=>{ e.preventDefault(); cell.classList.add('dragover'); });
    cell.addEventListener('dragleave', ()=> cell.classList.remove('dragover'));
    cell.addEventListener('drop', e=>{
      e.preventDefault(); cell.classList.remove('dragover');
      const idx = Number(e.dataTransfer.getData('text/piece')); if (Number.isNaN(idx)) return;
      const cIndex = Number(cell.dataset.idx);
      if(state[cIndex] !== null){ addToTray(state[cIndex]); }
      const inTray = tray.querySelector(`.pz-piece[data-idx="${idx}"]`); if(inTray) inTray.remove();
      paintCell(cell, idx); state[cIndex] = idx;
      checkComplete(); renderEmptyMsg();
    });
    cell.addEventListener('click', ()=>{
      const cIndex = Number(cell.dataset.idx);
      if(state[cIndex] === null) return;
      addToTray(state[cIndex]); clearCell(cell); state[cIndex] = null; renderEmptyMsg();
      // si descolocan algo, quitamos celebración
      board.classList.remove('pz-complete'); banner.classList.remove('show');
    });
  });

  function paintCell(cell, idx){
    cell.setAttribute('aria-filled','true');
    cell.style.backgroundImage = `url('${IMG}')`;
    cell.style.backgroundSize = '300% 200%';
    cell.style.backgroundPosition = positions[idx];
  }
  function clearCell(cell){
    cell.setAttribute('aria-filled','false');
    cell.style.backgroundImage = '';
    cell.style.backgroundPosition = '';
  }

  function checkComplete(){
    const ok = state.every((v,i)=> v === i);
    if(!ok) return;
    // Destello en el tablero + frase
    grid.classList.add('pz-flash'); setTimeout(()=> grid.classList.remove('pz-flash'), 700);
    board.classList.add('pz-complete');
    banner.classList.add('show');
  }

  btnSave.addEventListener('click', ()=>{
    const payload = { state, tray: Array.from(tray.querySelectorAll('.pz-piece')).map(p=>Number(p.dataset.idx)) };
    localStorage.setItem(SKEY_PZ, JSON.stringify(payload));
    btnSave.textContent = 'Guardado ✓'; setTimeout(()=> btnSave.textContent = 'Guardar puzzle', 900);
  });

  btnReset.addEventListener('click', ()=>{
    if(!confirm('¿Desarmar el puzzle y vaciar la bandeja?')) return;
    localStorage.removeItem(SKEY_PZ);
    grid.querySelectorAll('.pz-cell').forEach(clearCell);
    state = new Array(CELLS).fill(null);
    tray.innerHTML = '';
    board.classList.remove('pz-complete'); banner.classList.remove('show');
    renderEmptyMsg();
  });

  btnBack.addEventListener('click', ()=> window.location.href = 'index.html');

  (function restore(){
    try{
      const saved = JSON.parse(localStorage.getItem(SKEY_PZ)||'null');
      if(!saved) { renderEmptyMsg(); return; }
      state = saved.state && Array.isArray(saved.state) && saved.state.length===CELLS ? saved.state : new Array(CELLS).fill(null);
      grid.querySelectorAll('.pz-cell').forEach(cell=>{
        const i = Number(cell.dataset.idx);
        if(state[i] !== null) paintCell(cell, state[i]); else clearCell(cell);
      });
      (saved.tray||[]).forEach(addToTray);
      renderEmptyMsg();
      // si ya estaba completo, vuelves a ver la celebración
      if(state.every((v,i)=>v===i)){ board.classList.add('pz-complete'); banner.classList.add('show'); }
    }catch(_){ renderEmptyMsg(); }
  })();
})();
</script>
  <script>
(() => {
  // Selecciona contenedores existentes de tu puzzle
  const board = document.getElementById('pzBoard');     // el tablero 3x2 negro
  const bag   = document.getElementById('pzBag');       // la “bandeja”/caja donde caen las piezas
  const btnDiscover = document.getElementById('pzDiscover'); // botón "Descubrir pieza"
  const btnReset    = document.getElementById('pzReset');    // "Desarmar puzzle"
  if (!board || !bag || !btnDiscover) return;

  const COLS = 3, ROWS = 2;       // 6 piezas
  const total = COLS * ROWS;
  const used = new Set();         // índices ya descubiertos

  // Utilidad: crea una pieza con su trozo exacto
  function createPiece(idx) {
    const col = idx % COLS;
    const row = Math.floor(idx / COLS);

    const el = document.createElement('div');
    el.className = 'pz-piece';
    el.dataset.idx = String(idx);
    // tamaño visual (ajusta si usas otros)
    el.style.width  = '120px';
    el.style.height = '120px';
    el.style.border = '1px solid rgba(255,255,255,.18)';
    el.style.borderRadius = '10px';
    el.style.boxShadow = '0 6px 16px rgba(0,0,0,.35)';
    el.style.backgroundSize = '300% 200%'; // Fijo a 3x2

    // Posición de fondo por coordenadas de la rejilla: 0%, 50%, 100%
    const posX = (COLS === 1) ? 0 : (col / (COLS - 1)) * 100;
    const posY = (ROWS === 1) ? 0 : (row / (ROWS - 1)) * 100;
    el.style.backgroundPosition = `${posX}% ${posY}%`;

    // Hacerla draggable (compatible móvil)
    enableDrag(el);
    return el;
  }

  // Descubrir una nueva pieza (no repetida)
  function discoverOne() {
    if (used.size >= total) return;
    // encuentra el primer índice libre (puedes randomizar si quieres)
    let idx = 0;
    while (idx < total && used.has(idx)) idx++;
    if (idx >= total) return;

    used.add(idx);
    const piece = createPiece(idx);
    bag.appendChild(piece);
  }

  // Reset del puzzle: vacía bandeja + tablero
  function resetPuzzle() {
    used.clear();
    ;[...bag.children, ...board.querySelectorAll('.pz-piece')].forEach(n => n.remove());
  }

  // Drag & drop simple con pointer events (va en móvil)
  function enableDrag(el){
    let ox=0, oy=0, sx=0, sy=0, dragging=false;

    el.style.position='absolute';
    el.style.left = '0px';
    el.style.top  = '0px';

    const onDown = (e)=>{
      dragging = true;
      const p = getPoint(e);
      ox = p.x; oy = p.y;
      const r = el.getBoundingClientRect();
      sx = r.left + window.scrollX;
      sy = r.top  + window.scrollY;
      el.setPointerCapture(e.pointerId || 1);
    };
    const onMove = (e)=>{
      if(!dragging) return;
      const p = getPoint(e);
      const dx = p.x - ox;
      const dy = p.y - oy;
      el.style.left = (sx + dx - bag.getBoundingClientRect().left - window.scrollX) + 'px';
      el.style.top  = (sy + dy - bag.getBoundingClientRect().top  - window.scrollY) + 'px';
    };
    const onUp = ()=>{
      dragging = false;
      // Si sueltas sobre el tablero, lo metemos dentro y lo “snappeamos”
      const br = board.getBoundingClientRect();
      const er = el.getBoundingClientRect();
      const centerX = er.left + er.width/2;
      const centerY = er.top  + er.height/2;

      if (centerX >= br.left && centerX <= br.right && centerY >= br.top && centerY <= br.bottom){
        // mover al tablero
        board.appendChild(el);
        el.style.position = 'absolute';

        // calcula celda destino según centro
        const cW = br.width / COLS;
        const cH = br.height / ROWS;
        const col = Math.max(0, Math.min(COLS-1, Math.floor((centerX - br.left) / cW)));
        const row = Math.max(0, Math.min(ROWS-1, Math.floor((centerY - br.top)  / cH)));

        // encajar (snap)
        el.style.left = (col * cW) + 'px';
        el.style.top  = (row * cH) + 'px';
        el.style.width  = cW + 'px';
        el.style.height = cH + 'px';

        // ¿completado? si hay 6 piezas dentro, mostramos glow + frase (si ya lo tenías, esto no molesta)
        const placed = board.querySelectorAll('.pz-piece').length;
        if (placed === total){
          board.classList.add('pz-complete');
          showSolvedLine(); // si ya tenías esta función, genial; si no, no hace nada
        }
      } else {
        // vuelve a la bandeja si soltó fuera
        bag.appendChild(el);
        el.style.width  = '120px';
        el.style.height = '120px';
        el.style.left = '0px';
        el.style.top  = '0px';
      }
    };

    el.addEventListener('pointerdown', onDown);
    el.addEventListener('pointermove', onMove);
    el.addEventListener('pointerup',   onUp);
    el.addEventListener('pointercancel', onUp);
  }

  function getPoint(e){
    if (e.touches && e.touches[0]) return {x:e.touches[0].clientX, y:e.touches[0].clientY};
    return {x:e.clientX || 0, y:e.clientY || 0};
  }

  // Botones
  btnDiscover.addEventListener('click', discoverOne);
  btnReset?.addEventListener('click', resetPuzzle);

  // Estilos de “completado” si aún no los tienes
  const style = document.createElement('style');
  style.textContent = `
    #pzBoard{ position:relative; }
    #pzBoard.pz-complete{ box-shadow:0 0 0 3px rgba(255,255,255,.6), 0 0 24px rgba(255,255,255,.35) inset; }
  `;
  document.head.appendChild(style);

  // (Opcional) marca de completado si no existía
  function showSolvedLine(){
    if (document.getElementById('pzSolved')) return;
    const line = document.createElement('div');
    line.id = 'pzSolved';
    line.textContent = 'A veces, el tiempo se reconoce en su engranaje.';
    Object.assign(line.style, {
      marginTop:'10px', textAlign:'center', fontWeight:'800', opacity:'.95'
    });
    board.parentElement.appendChild(line);
  }
})();
</script>

</body>
</html>






